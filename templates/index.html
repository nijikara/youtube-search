<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>{{ title }}</title>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
        crossorigin="anonymous">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"
          integrity="sha384-vjEeVQ0GQf0mM8uS2k8nYp+QmD5hH8Vf6vQf5wC9l9yQZy5cKQmQbZpJ8W6j7l9h"
          crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/js/jquery.tablesorter.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/css/theme.default.min.css">

  <style>
    #fav-table th { background-color: pink; }
    .text-content { max-height: 100px; overflow-y: auto; }
    .table td { max-width: 420px; }
    .muted { color:#777; }
  </style>

  <script>
    $(document).ready(function() {
      $('#fav-table').tablesorter();

      // 検索後はフォームをたたむ（結果がある時）
      var hasResults = {{ (sorce|length) > 0 | lower }};
      if (hasResults) {
        $('#searchCollapse').collapse('hide');
      } else {
        $('#searchCollapse').collapse('show');
      }
    });
  </script>
</head>

<body>
<div class="container-fluid mt-3">

  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="small muted">
      Quota(推定): {{ quota.used_est }} / {{ quota.limit }}（残り {{ quota.remaining_est }}） / 次回リセット: {{ quota.next_reset_jst }}
    </div>
    <button class="btn btn-sm btn-outline-secondary" type="button" data-toggle="collapse" data-target="#searchCollapse" aria-expanded="true">
      検索フォームを開閉
    </button>
  </div>

  <div id="searchCollapse" class="collapse show">
    <div class="card mb-3">
      <div class="card-body">
        <form method="GET" action="/scraping">

          <div class="form-row">
            <div class="form-group col-md-4">
              <label>検索ワード</label>
              <input type="text" class="form-control" name="word" value="{{ form.word }}">
            </div>

            <div class="form-group col-md-2">
              <label>from</label>
              <input type="date" class="form-control" name="from" value="{{ form.from }}">
            </div>

            <div class="form-group col-md-2">
              <label>to</label>
              <input type="date" class="form-control" name="to" value="{{ form.to }}">
            </div>

            <div class="form-group col-md-4">
              <label>チャンネルID（UC... / URL / @handle）</label>
              <input type="text" class="form-control" name="channel-id" value="{{ form.channel_id }}">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-2">
              <label>並び順</label>
              <select class="form-control" name="order">
                <option value="date" {{ "selected" if form.order=="date" else "" }}>date</option>
                <option value="viewCount" {{ "selected" if form.order=="viewCount" else "" }}>viewCount</option>
                <option value="relevance" {{ "selected" if form.order=="relevance" else "" }}>relevance</option>
              </select>
            </div>

            <div class="form-group col-md-2">
              <label>再生数 下限</label>
              <input type="number" class="form-control" name="viewcount-level" value="{{ form.viewcount_min }}">
            </div>

            <div class="form-group col-md-2">
              <label>再生数 上限</label>
              <input type="number" class="form-control" name="viewcount-max" value="{{ form.viewcount_max }}">
            </div>

            <div class="form-group col-md-2">
              <label>登録者 下限</label>
              <input type="number" class="form-control" name="subscribercount-level" value="{{ form.sub_min }}">
            </div>

            <div class="form-group col-md-2">
              <label>登録者 上限</label>
              <input type="number" class="form-control" name="subscribercount-max" value="{{ form.sub_max }}">
            </div>

            <div class="form-group col-md-2">
              <label>取得件数</label>
              <input type="number" class="form-control" name="video-count" value="{{ form.video_count }}">
            </div>
          </div>

          <button type="submit" class="btn btn-primary">出力</button>
        </form>
      </div>
    </div>
  </div>

  {% if sorce and sorce[0].get('mode') == 'error' %}
    <div class="alert alert-danger">
      {{ sorce[0].get('error') }}
    </div>
  {% endif %}

  {% if sorce and sorce[0].get('mode') == 'rss' %}
    <div class="alert alert-warning">
      本日クォータ超過のため、チャンネルRSS(Atom)からの簡易結果です（再生数などは0表示/最新分のみ）。
    </div>
  {% endif %}

  <div class="card-body">
    <div>検索結果: {{ sorce | length }}件</div>

    {% set cols = [
      'publishedAt',
      'title',
      'description',
      'viewCount',
      'likeCount',
      'commentCount',
      'videoDuration',
      'thumbnails',
      'video_url',
      'name',
      'subscriberCount',
      'channel_icon'
    ] %}

    <table id="fav-table" class="table table-bordered table-sm">
      <thead>
        <tr>
          <th>投稿日時</th>
          <th>タイトル</th>
          <th>概要</th>
          <th>再生数</th>
          <th>高評価数</th>
          <th>コメント数</th>
          <th>動画時間</th>
          <th>サムネイル</th>
          <th>URL</th>
          <th>チャンネル名</th>
          <th>登録者数</th>
          <th>チャンネルURL</th>
        </tr>
      </thead>

      <tbody>
      {% for row in sorce %}
        {% if row.get('mode') == 'error' %}
          {# error行は表示しない #}
        {% else %}
        <tr>
          {% for key in cols %}
            <td>
              {% if key == 'thumbnails' %}
                <a href="{{ row[key] }}" target="_blank">
                  <img src="{{ row[key] }}" height="90">
                </a>

              {% elif key == 'channel_icon' %}
                <a href="{{ row['channel_icon'][0] }}" target="_blank">
                  <img src="{{ row['channel_icon'][1] }}" height="60">
                </a>

              {% elif key == 'commentCount' %}
                <a href="/comment?video-id={{ row['video_url'] }}" target="_blank">
                  {{ "{:,}".format(row['commentCount']|int) }}
                </a>

              {% elif key in ['viewCount', 'likeCount', 'subscriberCount'] %}
                <div class="text-content">{{ "{:,}".format(row[key]|int) }}</div>

              {% elif key == 'video_url' %}
                <div class="text-content"><a href="{{ row[key] }}" target="_blank">{{ row[key] }}</a></div>

              {% else %}
                <div class="text-content">{{ row[key] }}</div>
              {% endif %}
            </td>
          {% endfor %}
        </tr>
        {% endif %}
      {% endfor %}
      </tbody>
    </table>

  </div>
</div>
</body>
</html>

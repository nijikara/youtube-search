<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ title }}</title>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
        crossorigin="anonymous">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/css/theme.default.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Noto Sans JP', system-ui, -apple-system, 'Segoe UI', Roboto, 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif; }

    /* --- sticky search --- */
    #search-sticky {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: #fff;
      border-bottom: 1px solid rgba(0,0,0,.08);
    }

    .small-muted { color:#666; font-size: 12px; }
    .nowrap { white-space: nowrap; }
    .text-content {
      max-height: 6.5em;
      overflow: auto;
      white-space: pre-wrap;
    }

    #fav-table-normal th, #fav-table-shorts th { background-color: #ffe0ef; }

    .thumb-img { height: 72px; width: auto; border-radius: 6px; }
    .icon-img { height: 32px; width: 32px; border-radius: 50%; }

    .btn-grid.active { border-width: 2px; }

    .xshare-card {
      border: 1px solid rgba(0,0,0,.1);
      border-radius: 10px;
      padding: 12px;
      background: #fafafa;
    }

    .xshare-controls input[type="number"] { width: 110px; }
    .xshare-controls .form-check { margin-right: 12px; }

    .tight-gap { gap: 6px; }
  </style>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/js/jquery.tablesorter.min.js"></script>
</head>

<body>
<div class="container-fluid" id="page-top">

  <div id="search-sticky" class="py-2">
    <div class="d-flex align-items-center justify-content-between px-2">
      <div class="h5 m-0">search_youtube</div>
      <div>
        <button id="toggle-search" class="btn btn-sm btn-outline-primary">検索フォーム</button>
        <a class="btn btn-sm btn-outline-secondary" href="#xshare">X用まとめ画像</a>
      </div>
    </div>

    <div id="search-panel" class="mt-2 px-2" style="display:block;">
      <!-- コメント表示（URL/IDから） -->
      <form method="GET" action="/comment" target="_blank" class="form-inline mb-2">
        <label class="mr-2">動画URL/ID</label>
        <input type="text" class="form-control form-control-sm mr-2" name="video-id" style="min-width: 320px" placeholder="https://www.youtube.com/watch?v=... / 11桁ID">
        <button type="submit" class="btn btn-sm btn-secondary">コメント表示</button>
        <span class="small-muted ml-2">※ 検索結果のコメント数クリックでも開けます</span>
      </form>

      <!-- 検索フォーム -->
      <form method="GET" action="/scraping" class="border rounded p-2">
        <div class="form-row align-items-end">
          <div class="col-md-3 mb-2">
            <label class="small-muted">検索ワード</label>
            <input type="text" class="form-control form-control-sm" name="word" value="{{ form.word }}">
          </div>

          <div class="col-md-2 mb-2">
            <label class="small-muted">From</label>
            <input type="date" class="form-control form-control-sm" name="from" value="{{ form.from }}">
          </div>

          <div class="col-md-2 mb-2">
            <label class="small-muted">To</label>
            <input type="date" class="form-control form-control-sm" name="to" value="{{ form.to }}">
          </div>

          <div class="col-md-3 mb-2">
            <label class="small-muted">チャンネルURL/ID（任意）</label>
            <input type="text" class="form-control form-control-sm" name="channel-id" value="{{ form.channel_id }}" placeholder="https://www.youtube.com/@...">
          </div>

          <div class="col-md-2 mb-2">
            <label class="small-muted">並び順</label>
            <select class="form-control form-control-sm" name="order">
              <option value="date" {% if form.order=='date' %}selected{% endif %}>新しい順</option>
              <option value="relevance" {% if form.order=='relevance' %}selected{% endif %}>関連度</option>
              <option value="viewcount" {% if form.order=='viewcount' %}selected{% endif %}>再生数</option>
            </select>
          </div>
        </div>

        <div class="form-row align-items-end">
          <div class="col-md-2 mb-2">
            <label class="small-muted">再生数Min</label>
            <input type="number" class="form-control form-control-sm" name="viewcount-level" value="{{ form.viewcount_min }}" placeholder="0">
          </div>
          <div class="col-md-2 mb-2">
            <label class="small-muted">再生数Max</label>
            <input type="number" class="form-control form-control-sm" name="viewcount-max" value="{{ form.viewcount_max }}" placeholder="空=上限なし">
          </div>
          <div class="col-md-2 mb-2">
            <label class="small-muted">登録者Min</label>
            <input type="number" class="form-control form-control-sm" name="subscribercount-level" value="{{ form.sub_min }}" placeholder="0">
          </div>
          <div class="col-md-2 mb-2">
            <label class="small-muted">登録者Max</label>
            <input type="number" class="form-control form-control-sm" name="subscribercount-max" value="{{ form.sub_max }}" placeholder="空=上限なし">
          </div>
          <div class="col-md-2 mb-2">
            <label class="small-muted">取得件数</label>
            <input type="number" class="form-control form-control-sm" name="video-count" value="{{ form.video_count }}">
          </div>
          <div class="col-md-2 mb-2">
            <label class="small-muted">対象</label>
            <select class="form-control form-control-sm" name="kind">
              <option value="" {% if form.kind=='' %}selected{% endif %}>両方</option>
              <option value="normal" {% if form.kind=='normal' %}selected{% endif %}>通常</option>
              <option value="shorts" {% if form.kind=='shorts' %}selected{% endif %}>ショート</option>
            </select>
          </div>
        </div>

        <div class="d-flex align-items-center justify-content-between">
          <button type="submit" class="btn btn-sm btn-primary">検索</button>
          <div class="small-muted">
            {% if quota %}
              推定クォータ: {{ quota.used_estimate }}/{{ quota.daily_quota }} / リセット: {{ quota.reset_at_jst }}
            {% endif %}
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="mt-3 px-2">
    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <div class="d-flex align-items-center justify-content-between">
      <div>
        <div class="h6 m-0">検索結果</div>
        <div class="small-muted">通常: {{ normal_rows|length }} / ショート: {{ short_rows|length }} / 合計: {{ (normal_rows|length + short_rows|length) }}</div>
      </div>
      <a href="#page-top" class="btn btn-sm btn-outline-secondary">ページ上へ</a>
    </div>

    <!-- X share section -->
    <div id="xshare" class="xshare-card mt-3" data-share-sid="{{ share_sid }}" data-normal-count="{{ normal_rows|length }}" data-shorts-count="{{ short_rows|length }}">
      <div class="d-flex align-items-center justify-content-between">
        <div class="h6 m-0">X用まとめ画像（検索結果から生成）</div>
        <span class="small-muted">※ 画像は新規タブで表示（右クリック保存）</span>
      </div>

      <div class="row mt-2">
        <!-- normal -->
        <div class="col-lg-6 mb-3">
          <div class="font-weight-bold">通常動画（{{ normal_rows|length }}件）</div>
          <div class="xshare-controls d-flex flex-wrap align-items-center tight-gap mt-2">
            <div class="form-inline">
              <label class="mr-1">件数N</label>
              <input id="n-normal" type="number" class="form-control form-control-sm" min="1" value="{{ share_default_n_normal }}">
            </div>
            <div class="form-inline">
              <label class="mr-1">サムネ幅</label>
              <input id="tw-normal" type="number" class="form-control form-control-sm" min="120" value="480">
            </div>
            <div class="form-inline">
              <label class="mr-1">間隔</label>
              <input id="pad-normal" type="number" class="form-control form-control-sm" min="0" value="6">
            </div>
            <div class="form-check form-check-inline">
              <input id="show-title" class="form-check-input" type="checkbox" checked>
              <label class="form-check-label" for="show-title">タイトル</label>
            </div>
            <div class="form-check form-check-inline">
              <input id="show-channel" class="form-check-input" type="checkbox" checked>
              <label class="form-check-label" for="show-channel">チャンネル名</label>
            </div>
          </div>

          <div class="mt-2">
            <div class="small-muted">グリッド候補（Nの約数）</div>
            <div id="grid-normal" class="d-flex flex-wrap tight-gap mt-1"></div>
            <input id="rows-normal" type="hidden" value="1">
            <input id="cols-normal" type="hidden" value="1">
          </div>

          <div class="mt-2">
            <a id="open-normal" class="btn btn-sm btn-success" target="_blank" rel="noopener">通常まとめ画像を開く</a>
          </div>
        </div>

        <!-- shorts -->
        <div class="col-lg-6 mb-3">
          <div class="font-weight-bold">ショート（{{ short_rows|length }}件）</div>
          <div class="xshare-controls d-flex flex-wrap align-items-center tight-gap mt-2">
            <div class="form-inline">
              <label class="mr-1">件数N</label>
              <input id="n-shorts" type="number" class="form-control form-control-sm" min="1" value="{{ share_default_n_shorts }}">
            </div>
            <div class="form-inline">
              <label class="mr-1">サムネ幅</label>
              <input id="tw-shorts" type="number" class="form-control form-control-sm" min="120" value="360">
            </div>
            <div class="form-inline">
              <label class="mr-1">間隔</label>
              <input id="pad-shorts" type="number" class="form-control form-control-sm" min="0" value="6">
            </div>
            <div class="small-muted">※ ショートは左右の黒ベタ除去→縦長レイアウト</div>
          </div>

          <div class="mt-2">
            <div class="small-muted">グリッド候補（Nの約数）</div>
            <div id="grid-shorts" class="d-flex flex-wrap tight-gap mt-1"></div>
            <input id="rows-shorts" type="hidden" value="1">
            <input id="cols-shorts" type="hidden" value="1">
          </div>

          <div class="mt-2">
            <a id="open-shorts" class="btn btn-sm btn-success" target="_blank" rel="noopener">ショートまとめ画像を開く</a>
          </div>
        </div>
      </div>
    </div>

    {% macro result_table(table_id, rows) -%}
      <table id="{{ table_id }}" class="table table-bordered table-sm tablesorter">
        <thead>
          <tr>
            <th class="nowrap">投稿日時</th>
            <th>タイトル</th>
            <th>概要</th>
            <th class="nowrap">再生数</th>
            <th class="nowrap">高評価</th>
            <th class="nowrap">コメント</th>
            <th class="nowrap">動画時間</th>
            <th class="nowrap">サムネ</th>
            <th class="nowrap">URL</th>
            <th class="nowrap">チャンネル</th>
            <th class="nowrap">登録者</th>
            <th class="nowrap">アイコン</th>
          </tr>
        </thead>
        <tbody>
        {% for row in rows %}
          <tr>
            <td class="nowrap" data-sort-value="{{ row.get('publishedAt','') }}"><div class="text-content">{{ row.get('publishedAt','') }}</div></td>
            <td data-sort-value="{{ row.get('title','') }}"><div class="text-content">{{ row.get('title','') }}</div></td>
            <td><div class="text-content">{{ row.get('description','') }}</div></td>

            <td class="text-right" data-sort-value="{{ row.get('viewCount') or 0 }}">{{ "{:,}".format((row.get('viewCount') or 0)|int) }}</td>
            <td class="text-right" data-sort-value="{{ row.get('likeCount') or 0 }}">{{ "{:,}".format((row.get('likeCount') or 0)|int) }}</td>

            <td class="text-right" data-sort-value="{{ row.get('commentCount') or 0 }}">
              <a href="/comment?video-id={{ row.get('video_url','') }}" target="_blank" rel="noopener">{{ "{:,}".format((row.get('commentCount') or 0)|int) }}</a>
            </td>

            <td class="nowrap" data-sort-value="{{ row.get('videoDuration','') }}">{{ row.get('videoDuration','') }}</td>

            <td class="nowrap">
              {% if row.get('thumbnails') %}
                <a href="{{ row.get('thumbnails') }}" target="_blank" rel="noopener"><img class="thumb-img" src="{{ row.get('thumbnails') }}"></a>
              {% endif %}
            </td>

            <td class="nowrap">
              {% if row.get('video_url') %}
                <a href="{{ row.get('video_url') }}" target="_blank" rel="noopener">開く</a>
              {% endif %}
            </td>

            <td class="nowrap"><div class="text-content">{{ row.get('name','') }}</div></td>

            <td class="text-right" data-sort-value="{{ row.get('subscriberCount') or 0 }}">{{ "{:,}".format((row.get('subscriberCount') or 0)|int) }}</td>

            <td class="nowrap">
              {% set ci = row.get('channel_icon') %}
              {% if ci and ci|length >= 2 %}
                <a href="{{ ci[0] }}" target="_blank" rel="noopener"><img class="icon-img" src="{{ ci[1] }}"></a>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {%- endmacro %}

    {% if normal_rows|length > 0 %}
      <div class="mt-3">
        <div class="h6">通常動画</div>
        {{ result_table('fav-table-normal', normal_rows) }}
      </div>
    {% endif %}

    {% if short_rows|length > 0 %}
      <div class="mt-4">
        <div class="h6">ショート</div>
        {{ result_table('fav-table-shorts', short_rows) }}
      </div>
    {% endif %}

  </div>
</div>

<script>
(function() {
  // --- tablesorter ---
  $(function() {
    $('#fav-table-normal').tablesorter();
    $('#fav-table-shorts').tablesorter();
  });

  // --- search panel toggle + scroll ---
  const btn = document.getElementById('toggle-search');
  const panel = document.getElementById('search-panel');
  btn.addEventListener('click', () => {
    const isOpen = panel.style.display !== 'none';
    panel.style.display = isOpen ? 'none' : 'block';
    btn.textContent = isOpen ? '検索フォーム' : '検索フォーム（閉じる）';
    if (!isOpen) {
      // 開いたらそこへスクロール
      document.getElementById('search-sticky').scrollIntoView({behavior:'smooth', block:'start'});
    }
  });

  // --- X share build ---
  const xroot = document.getElementById('xshare');
  const sid = xroot.dataset.shareSid || '';

  function factors(n) {
    const out = [];
    n = Math.max(1, n|0);
    for (let i=1; i*i<=n; i++) {
      if (n % i === 0) {
        out.push([i, n/i]);
      }
    }
    // 低い段数→高い段数
    return out;
  }

  function setActive(container, rows, cols) {
    [...container.querySelectorAll('button')].forEach(b => {
      const r = parseInt(b.dataset.rows||'0',10);
      const c = parseInt(b.dataset.cols||'0',10);
      if (r === rows && c === cols) {
        b.classList.add('active');
        b.classList.remove('btn-outline-secondary');
        b.classList.add('btn-primary');
      } else {
        b.classList.remove('active');
        b.classList.add('btn-outline-secondary');
        b.classList.remove('btn-primary');
      }
    });
  }

  function buildGrid(kind) {
    const count = parseInt(xroot.dataset[kind + 'Count'] || '0', 10);
    const nInput = document.getElementById('n-' + kind);
    const n = Math.min(Math.max(parseInt(nInput.value || '1', 10), 1), Math.max(count, 1));
    nInput.value = n;

    const grid = document.getElementById('grid-' + kind);
    grid.innerHTML = '';

    const pairs = factors(n);
    // cols x rows 表記で並べたいので、(rows, cols) を作る
    // pairsは [small, large] なので rows=small, cols=large を基本
    pairs.forEach(([r, c]) => {
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'btn btn-sm btn-outline-secondary btn-grid';
      b.dataset.rows = String(r);
      b.dataset.cols = String(c);
      b.textContent = `${c}×${r}`; // cols×rows
      b.addEventListener('click', () => {
        document.getElementById('rows-' + kind).value = String(r);
        document.getElementById('cols-' + kind).value = String(c);
        setActive(grid, r, c);
        refreshLinks();
      });
      grid.appendChild(b);
    });

    // デフォルトは “なるべく正方形”
    let best = pairs[0];
    let bestScore = Infinity;
    pairs.forEach(([r, c]) => {
      const score = Math.abs((c / r) - 1);
      if (score < bestScore) { bestScore = score; best = [r, c]; }
    });

    const [dr, dc] = best;
    document.getElementById('rows-' + kind).value = String(dr);
    document.getElementById('cols-' + kind).value = String(dc);
    setActive(grid, dr, dc);
  }

  function refreshLinks() {
    if (!sid) return;

    const showTitle = document.getElementById('show-title').checked ? '1' : '0';
    const showChannel = document.getElementById('show-channel').checked ? '1' : '0';

    // normal
    {
      const kind = 'normal';
      const n = document.getElementById('n-normal').value;
      const rows = document.getElementById('rows-normal').value;
      const cols = document.getElementById('cols-normal').value;
      const tw = document.getElementById('tw-normal').value;
      const pad = document.getElementById('pad-normal').value;

      const qs = new URLSearchParams({sid, kind, n, rows, cols, thumb_w: tw, pad, show_title: showTitle, show_channel: showChannel});
      document.getElementById('open-normal').href = '/share_image?' + qs.toString();
    }

    // shorts
    {
      const kind = 'shorts';
      const n = document.getElementById('n-shorts').value;
      const rows = document.getElementById('rows-shorts').value;
      const cols = document.getElementById('cols-shorts').value;
      const tw = document.getElementById('tw-shorts').value;
      const pad = document.getElementById('pad-shorts').value;

      const qs = new URLSearchParams({sid, kind, n, rows, cols, thumb_w: tw, pad, show_title: showTitle, show_channel: showChannel});
      document.getElementById('open-shorts').href = '/share_image?' + qs.toString();
    }
  }

  // init
  buildGrid('normal');
  buildGrid('shorts');
  refreshLinks();

  // bind
  ['n-normal','tw-normal','pad-normal','n-shorts','tw-shorts','pad-shorts','show-title','show-channel'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('change', () => {
      if (id.startsWith('n-')) {
        buildGrid(id.includes('shorts') ? 'shorts' : 'normal');
      }
      refreshLinks();
    });
  });
})();
</script>
</body>
</html>

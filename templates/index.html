<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>{{ title }}</title>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
        crossorigin="anonymous">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/js/jquery.tablesorter.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/css/theme.default.min.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
          integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
          crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
          integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
          crossorigin="anonymous"></script>

  <style>
    body { padding: 16px; }
    #fav-table th { background-color: pink; }
    .text-content { max-height: 110px; overflow-y: auto; white-space: pre-wrap; }
    .table td { max-width: 520px; vertical-align: top; }
    .thumb img { border-radius: 6px; }
    .quota-box { background: #f7f7f7; border-radius: 10px; padding: 10px 12px; }
    .muted { color: #666; }
    .small { font-size: 12px; }
    .nowrap { white-space: nowrap; }
    .sticky-top-2 { position: sticky; top: 0; z-index: 2; background: #fff; padding-top: 8px; }
  </style>

  <!-- quota ã¯ JSã«ç›´åŸ‹ã‚ã—ãªã„ï¼ˆVS Codeã®JSè¨ºæ–­ãŒå£Šã‚Œã‚‹ã®ã§ï¼‰ -->
  <script id="quota-json" type="application/json">{{ quota | tojson }}</script>

  <script>
    function fmt(n){
      const x = Number(n);
      if (!Number.isFinite(x)) return String(n ?? "");
      return new Intl.NumberFormat("ja-JP").format(x);
    }

    function linkifyAndHashtagify($root){
      // YouTubeãƒªãƒ³ã‚¯ï¼ˆwatch/shortsï¼‰
      const exp = /(https:\/\/www\.youtube\.com\/(watch|shorts)[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
      // ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°
      const exp_hash = /#+([a-zA-Z0-9äºœ-ç†™ã-ã‚“ã‚¡-ãƒ¶ãƒ¼-é¾¥ï¤©-ï¨­.\-_]+)/g;

      $root.find(".js-text").each(function(){
        const html = $(this).html();
        let txt = html;
        txt = txt.replace(exp, "<a href='$1' target='_blank' rel='noopener noreferrer'>ğŸ”—</a>");
        txt = txt.replace(exp_hash, "<a href='https://www.youtube.com/hashtag/$1' target='_blank' rel='noopener noreferrer'>#$1</a>");
        $(this).html(txt);
      });
    }

    $(function(){
      // quotaè¡¨ç¤º
      try{
        const quota = JSON.parse(document.getElementById("quota-json").textContent || "{}");
        $("#quota-used").text(fmt(quota.used ?? quota.used_estimate ?? 0));
        $("#quota-remaining").text(fmt(quota.remaining ?? quota.remaining_estimate ?? ""));
        $("#quota-reset").text(String(quota.reset_at_jst ?? quota.reset ?? ""));
        if (quota.note) $("#quota-note").text(String(quota.note));
      }catch(e){
        // ä½•ã‚‚ã—ãªã„
      }

      // tablesorter
      $("#fav-table").tablesorter({
        theme: "default",
        headers: {
          3: { sorter: "digit" },  // å†ç”Ÿæ•°
          4: { sorter: "digit" },  // é«˜è©•ä¾¡
          5: { sorter: "digit" },  // ã‚³ãƒ¡ãƒ³ãƒˆæ•°
          10:{ sorter: "digit" }   // ç™»éŒ²è€…æ•°
        }
      });

      linkifyAndHashtagify($(document));
    });
  </script>
</head>

<body>

  <div class="sticky-top-2">
    <div class="d-flex justify-content-between align-items-center">
      <h4 class="m-0">YouTube æ¤œç´¢</h4>
      <div class="quota-box small">
        <div><strong>Quota</strong> used: <span id="quota-used"></span> / remaining: <span id="quota-remaining"></span></div>
        <div class="muted">reset: <span id="quota-reset"></span> <span id="quota-note"></span></div>
      </div>
    </div>

    <div class="mt-2">
      <button class="btn btn-sm btn-outline-primary" type="button" data-toggle="collapse" data-target="#searchPanel"
              aria-expanded="false" aria-controls="searchPanel">
        æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã / é–‰ã˜ã‚‹
      </button>

      <span class="ml-2 small muted">
        {% if sorce %}
          æ¤œç´¢çµæœ: <strong>{{ sorce | length }}</strong> ä»¶
        {% else %}
          æ¤œç´¢çµæœ: 0 ä»¶
        {% endif %}
      </span>
    </div>
  </div>

  {# åˆå›ã¯é–‹ãã€æ¤œç´¢å¾Œï¼ˆçµæœãŒã‚ã‚‹æ™‚ï¼‰ã¯ç•³ã‚€ #}
  <div id="searchPanel" class="collapse {% if not sorce %}show{% endif %} mt-3">
    <div class="card">
      <div class="card-body">
        <form method="GET" action="/scraping">
          <div class="form-row">
            <div class="form-group col-md-4">
              <label>æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰</label>
              <input type="text" class="form-control" name="word" value="{{ form.word }}">
            </div>

            <div class="form-group col-md-2">
              <label>from</label>
              <input type="date" class="form-control" name="from" value="{{ form.from }}">
            </div>

            <div class="form-group col-md-2">
              <label>to</label>
              <input type="date" class="form-control" name="to" value="{{ form.to }}">
            </div>

            <div class="form-group col-md-2">
              <label>å–å¾—ä»¶æ•°</label>
              <input type="number" class="form-control" name="video-count" value="{{ form.video_count }}">
            </div>

            <div class="form-group col-md-2">
              <label>ä¸¦ã³é †</label>
              <select class="form-control" name="order">
                <option value="date" {% if form.order == "date" %}selected{% endif %}>æ–°ã—ã„é †</option>
                <option value="viewcount" {% if form.order == "viewcount" %}selected{% endif %}>å†ç”Ÿæ•°é †</option>
                <option value="relevance" {% if form.order == "relevance" %}selected{% endif %}>é–¢é€£åº¦</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-6">
              <label>ãƒãƒ£ãƒ³ãƒãƒ«ID / URLï¼ˆä»»æ„ï¼‰</label>
              <input type="text" class="form-control" name="channel-id" value="{{ form.channel_id }}">
              <div class="small muted">ä¾‹: UCxxxx / https://www.youtube.com/@xxxx</div>
            </div>

            <div class="form-group col-md-3">
              <label>å†ç”Ÿæ•°ä¸‹é™</label>
              <input type="number" class="form-control" name="viewcount-level" value="{{ form.viewcount_min }}">
            </div>
            <div class="form-group col-md-3">
              <label>å†ç”Ÿæ•°ä¸Šé™</label>
              <input type="number" class="form-control" name="viewcount-max" value="{{ form.viewcount_max }}">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group col-md-3">
              <label>ç™»éŒ²è€…æ•°ä¸‹é™</label>
              <input type="number" class="form-control" name="subscribercount-level" value="{{ form.sub_min }}">
            </div>
            <div class="form-group col-md-3">
              <label>ç™»éŒ²è€…æ•°ä¸Šé™</label>
              <input type="number" class="form-control" name="subscribercount-max" value="{{ form.sub_max }}">
            </div>

            <div class="form-group col-md-6 d-flex align-items-end justify-content-end">
              <button type="submit" class="btn btn-primary">å‡ºåŠ›</button>
            </div>
          </div>
        </form>

        <hr>

        <form method="GET" action="/comment" class="form-inline">
          <label class="mr-2">å‹•ç”»URL / IDï¼ˆã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤ºï¼‰</label>
          <input type="text" class="form-control mr-2" name="video-id" style="min-width: 420px;">
          <button type="submit" class="btn btn-outline-secondary">ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º</button>
        </form>

      </div>
    </div>
  </div>

  <div class="mt-3">
    {% set cols = [
      'publishedAt',
      'title',
      'description',
      'viewCount',
      'likeCount',
      'commentCount',
      'videoDuration',
      'thumbnails',
      'video_url',
      'name',
      'subscriberCount',
      'channel_icon'
    ] %}

    <table id="fav-table" class="table table-bordered table-sm">
      <thead>
        <tr>
          <th class="nowrap">æŠ•ç¨¿æ—¥æ™‚</th>
          <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
          <th>æ¦‚è¦</th>
          <th class="nowrap">å†ç”Ÿæ•°</th>
          <th class="nowrap">é«˜è©•ä¾¡æ•°</th>
          <th class="nowrap">ã‚³ãƒ¡ãƒ³ãƒˆæ•°</th>
          <th class="nowrap">å‹•ç”»æ™‚é–“</th>
          <th class="nowrap">ã‚µãƒ ãƒ</th>
          <th class="nowrap">URL</th>
          <th class="nowrap">ãƒãƒ£ãƒ³ãƒãƒ«å</th>
          <th class="nowrap">ç™»éŒ²è€…æ•°</th>
          <th class="nowrap">ãƒãƒ£ãƒ³ãƒãƒ«</th>
        </tr>
      </thead>

      <tbody>
      {% for row in sorce %}
        <tr>
          {% for key in cols %}
            {% if key in ['viewCount','likeCount','commentCount','subscriberCount'] %}
              <td class="nowrap" data-sort-value="{{ row[key] | int }}">
                {% if key == 'commentCount' %}
                  <a href="/comment?video-id={{ row['video_url'] }}" target="_blank" rel="noopener noreferrer">
                    {{ "{:,}".format(row[key] | int) }}
                  </a>
                {% else %}
                  {{ "{:,}".format(row[key] | int) }}
                {% endif %}
              </td>

            {% elif key == 'thumbnails' %}
              <td class="thumb">
                <a href="{{ row[key] }}" target="_blank" rel="noopener noreferrer">
                  <img src="{{ row[key] }}" height="90" alt="thumb">
                </a>
              </td>

            {% elif key == 'channel_icon' %}
              <td class="thumb">
                <a href="{{ row['channel_icon'][0] }}" target="_blank" rel="noopener noreferrer">
                  <img src="{{ row['channel_icon'][1] }}" height="60" alt="channel">
                </a>
              </td>

            {% elif key == 'video_url' %}
              <td class="nowrap">
                <div class="js-text text-content">{{- row[key] | e -}}</div>
              </td>

            {% else %}
              <td>
                <div class="js-text text-content">{{- (row[key] | default('')) | e -}}</div>
              </td>
            {% endif %}
          {% endfor %}
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>{{ title }}</title>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
        crossorigin="anonymous">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/js/jquery.tablesorter.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/css/theme.default.min.css">

  <style>
    body { background: #f7f7f7; }
    .sticky-wrap { position: sticky; top: 0; z-index: 1040; }
    .search-card { border-radius: 12px; box-shadow: 0 4px 14px rgba(0,0,0,.08); }
    .results-card { border-radius: 12px; box-shadow: 0 4px 14px rgba(0,0,0,.08); }
    .section-title { font-weight: 700; }
    .small-muted { color: #666; font-size: 12px; }
    .text-content { max-height: 110px; overflow: auto; white-space: pre-wrap; }
    .nowrap { white-space: nowrap; }
    .thumb-img { height: 90px; border-radius: 6px; }
    .channel-img { height: 60px; border-radius: 50%; }
    .badge-kind { font-size: 12px; }
    .btn-grid { margin: 2px; }
    .btn-grid.active { border: 2px solid #007bff; }
    .share-preview { max-width: 100%; border: 1px solid #ddd; border-radius: 8px; background: #fff; }
    .form-toggle { cursor: pointer; }
    .gap-compact td { padding: .35rem; }
  </style>

  <script>
    function smoothScrollTo(el) {
      if (!el) return;
      el.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    function divisors(n) {
      const ds = [];
      for (let i = 1; i * i <= n; i++) {
        if (n % i === 0) {
          ds.push(i);
          if (i !== n / i) ds.push(n / i);
        }
      }
      return ds.sort((a,b)=>a-b);
    }

    function bestGrid(n, targetRatio, cellRatio) {
      // gridRatio ≈ (cols/rows) * cellRatio
      let best = null;
      const ds = divisors(n);
      ds.forEach(r => {
        const c = n / r;
        const ratio = (c / r) * cellRatio;
        const score = Math.abs(Math.log(ratio / targetRatio));
        if (!best || score < best.score) best = { r, c, score, ratio };
      });
      return best;
    }

    function getKindCounts() {
      const root = document.getElementById("share-panel");
      if (!root) return { normal: 0, shorts: 0 };
      return {
        normal: parseInt(root.getAttribute("data-normal-count") || "0", 10),
        shorts: parseInt(root.getAttribute("data-shorts-count") || "0", 10),
      };
    }

    function currentKind() {
      const v = document.querySelector('input[name="share-kind"]:checked');
      return v ? v.value : "normal";
    }

    function currentTargetRatio() {
      const sel = document.getElementById("share-target");
      const v = sel ? sel.value : "16:9";
      if (v === "1:1") return 1.0;
      if (v === "9:16") return 9/16;
      return 16/9;
    }

    function currentCellRatio(kind) {
      // server side default: normal=480/360, shorts=360/640
      return (kind === "shorts") ? (360/640) : (480/360);
    }

    function rebuildGridButtons() {
      const kind = currentKind();
      const counts = getKindCounts();
      const n = (kind === "shorts") ? counts.shorts : counts.normal;

      const wrap = document.getElementById("grid-buttons");
      const hint = document.getElementById("grid-hint");
      const gridInput = document.getElementById("share-grid");
      if (!wrap || !gridInput) return;

      wrap.innerHTML = "";

      if (!n || n <= 0) {
        hint.textContent = "対象が0件です";
        gridInput.value = "";
        return;
      }

      const target = currentTargetRatio();
      const cellRatio = currentCellRatio(kind);
      const best = bestGrid(n, target, cellRatio);

      hint.textContent = `件数 ${n} の約数パターンから選べます（おすすめ: ${kind==="shorts" ? "9:16寄せ" : "16:9寄せ"}）`;

      const ds = divisors(n);

      // なるべく「横長→縦長」まで見やすい順に並べる（colsが多い順）
      const pairs = ds.map(r => ({ r, c: n / r })).sort((a,b)=>b.c - a.c);

      const current = gridInput.value;

      pairs.forEach(p => {
        const label = `${p.r}x${p.c}`;
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn btn-sm btn-outline-primary btn-grid";
        btn.textContent = label + ((best && best.r===p.r && best.c===p.c) ? " ★" : "");
        btn.setAttribute("data-grid", label);
        if (current === label || (!current && best && best.r===p.r && best.c===p.c)) {
          btn.classList.add("active");
          gridInput.value = label;
        }
        btn.addEventListener("click", () => {
          document.querySelectorAll(".btn-grid").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          gridInput.value = label;
          updateSharePreview();
        });
        wrap.appendChild(btn);
      });

      updateSharePreview();
    }

    function updateSharePreview(kindOverride) {
      const root = document.getElementById("share-panel");
      if (!root) return;

      const sid = root.getAttribute("data-sid");
      if (!sid) return;

      const kind = kindOverride || currentKind();
      const grid = (document.getElementById("share-grid") || {}).value || "";
      const mode = (document.getElementById("share-mode") || {}).value || "original";
      const outW = (document.getElementById("share-outw") || {}).value || "2400";
      const pad = (document.getElementById("share-pad") || {}).value || "6";

      const showTitle = document.getElementById("show-title")?.checked ? "1" : "0";
      const showChannel = document.getElementById("show-channel")?.checked ? "1" : "0";

      const qs = new URLSearchParams({
        sid: sid,
        kind: kind,
        grid: grid,
        mode: mode,
        out_w: outW,
        pad: pad,
        show_title: showTitle,
        show_channel: showChannel,
      });

      const url = "/share_image?" + qs.toString();

      const img = document.getElementById("share-preview-img");
      const link = document.getElementById("share-open-link");
      if (img) img.src = url;
      if (link) link.href = url;
      return url;
    }

    $(document).ready(function () {
      // tablesorter
      $(".fav-table").tablesorter();

      // search form collapse scroll
      $("#toggle-form").on("click", function () {
        const form = document.getElementById("search-form");
        setTimeout(() => smoothScrollTo(form), 50);
      });

      // share kind change
      $('input[name="share-kind"]').on("change", function () {
        rebuildGridButtons();
      });

      // share options change
      $("#share-target, #share-mode, #share-outw, #share-pad, #show-title, #show-channel").on("change", function () {
        rebuildGridButtons();
      });

      // initial build
      rebuildGridButtons();

      // open buttons
      $("#btn-open-normal").on("click", function () {
        updateSharePreview("normal");
        document.getElementById("share-open-link").click();
      });
      $("#btn-open-shorts").on("click", function () {
        updateSharePreview("shorts");
        document.getElementById("share-open-link").click();
      });
    });
  </script>
</head>

<body>
  <div class="container-fluid py-3">

    <!-- Sticky Search -->
    <div class="sticky-wrap mb-3">
      <div class="card search-card">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <div class="section-title">YouTube 検索</div>
              <div class="small-muted">検索条件を開閉できます（開閉したらフォーム位置へジャンプ）</div>
            </div>
            <button id="toggle-form" class="btn btn-sm btn-outline-secondary" type="button" data-toggle="collapse" data-target="#search-collapse" aria-expanded="true" aria-controls="search-collapse">
              検索フォームの開閉
            </button>
          </div>

          <div id="search-form"></div>

          <div class="collapse show mt-3" id="search-collapse">
            <form method="GET" action="/scraping">
              <div class="form-row">
                <div class="form-group col-md-3">
                  <label>検索ワード</label>
                  <input type="text" class="form-control" name="word" value="{{ form.word }}">
                </div>
                <div class="form-group col-md-2">
                  <label>From</label>
                  <input type="date" class="form-control" name="from" value="{{ form.from }}">
                </div>
                <div class="form-group col-md-2">
                  <label>To</label>
                  <input type="date" class="form-control" name="to" value="{{ form.to }}">
                </div>
                <div class="form-group col-md-3">
                  <label>チャンネルID / URL / @handle</label>
                  <input type="text" class="form-control" name="channel-id" value="{{ form.channel_id }}">
                </div>
                <div class="form-group col-md-2">
                  <label>並び順</label>
                  <select class="form-control" name="order">
                    <option value="date" {% if form.order=="date" %}selected{% endif %}>date</option>
                    <option value="viewCount" {% if form.order=="viewCount" %}selected{% endif %}>viewCount</option>
                    <option value="relevance" {% if form.order=="relevance" %}selected{% endif %}>relevance</option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group col-md-2">
                  <label>再生数 下限</label>
                  <input type="number" class="form-control" name="viewcount-level" value="{{ form.viewcount_min }}">
                </div>
                <div class="form-group col-md-2">
                  <label>再生数 上限</label>
                  <input type="number" class="form-control" name="viewcount-max" value="{{ form.viewcount_max }}">
                </div>
                <div class="form-group col-md-2">
                  <label>登録者 下限</label>
                  <input type="number" class="form-control" name="subscribercount-level" value="{{ form.sub_min }}">
                </div>
                <div class="form-group col-md-2">
                  <label>登録者 上限</label>
                  <input type="number" class="form-control" name="subscribercount-max" value="{{ form.sub_max }}">
                </div>
                <div class="form-group col-md-2">
                  <label>取得件数</label>
                  <input type="number" class="form-control" name="video-count" value="{{ form.video_count }}">
                </div>
                <div class="form-group col-md-2">
                  <label>検索対象</label>
                  <select class="form-control" name="video-type">
                    <option value="" {% if form.video_type=="" %}selected{% endif %}>&nbsp;</option>
                    <option value="normal" {% if form.video_type=="normal" %}selected{% endif %}>通常のみ</option>
                    <option value="shorts" {% if form.video_type=="shorts" %}selected{% endif %}>ショートのみ</option>
                  </select>
                </div>
              </div>

              <button class="btn btn-primary">検索</button>
            </form>
          </div>

          {% if errors and errors|length > 0 %}
            <div class="mt-3 alert alert-danger">
              {% for e in errors %}
                <div>{{ e }}</div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Share Panel -->
    {% if share_sid %}
    <div class="card results-card mb-3" id="share-panel"
         data-sid="{{ share_sid }}"
         data-normal-count="{{ share_counts.normal }}"
         data-shorts-count="{{ share_counts.shorts }}">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="section-title">X用まとめ画像</div>
            <div class="small-muted">
              通常: {{ share_counts.normal }} 件 / ショート: {{ share_counts.shorts }} 件（クリックで別々に生成）
            </div>
          </div>
          <div class="text-right">
            <button class="btn btn-sm btn-outline-primary" id="btn-open-normal" type="button" {% if share_counts.normal==0 %}disabled{% endif %}>通常を生成</button>
            <button class="btn btn-sm btn-outline-dark" id="btn-open-shorts" type="button" {% if share_counts.shorts==0 %}disabled{% endif %}>ショートを生成</button>
            <a id="share-open-link" href="#" target="_blank" rel="noopener" style="display:none">open</a>
          </div>
        </div>

        <hr>

        <div class="form-row">
          <div class="form-group col-md-2">
            <label>プレビュー種別</label>
            <div class="custom-control custom-radio">
              <input class="custom-control-input" type="radio" id="kind-normal" name="share-kind" value="normal" checked>
              <label class="custom-control-label" for="kind-normal">通常</label>
            </div>
            <div class="custom-control custom-radio">
              <input class="custom-control-input" type="radio" id="kind-shorts" name="share-kind" value="shorts">
              <label class="custom-control-label" for="kind-shorts">ショート（左右黒ベタ除去）</label>
            </div>
          </div>

          <div class="form-group col-md-2">
            <label>目標比率</label>
            <select id="share-target" class="form-control">
              <option value="16:9" selected>16:9</option>
              <option value="1:1">1:1</option>
              <option value="9:16">9:16</option>
            </select>
          </div>

          <div class="form-group col-md-2">
            <label>出力モード</label>
            <select id="share-mode" class="form-control">
              <option value="original" selected>原寸優先</option>
              <option value="fit">幅にフィット</option>
            </select>
          </div>

          <div class="form-group col-md-2">
            <label>幅（fit時）</label>
            <select id="share-outw" class="form-control">
              <option value="1600">1600px</option>
              <option value="2400" selected>2400px</option>
              <option value="3200">3200px</option>
              <option value="4800">4800px</option>
            </select>
          </div>

          <div class="form-group col-md-2">
            <label>画像間隔(px)</label>
            <input id="share-pad" type="number" class="form-control" value="6" min="0" max="50">
          </div>

          <div class="form-group col-md-2">
            <label>表示</label>
            <div class="custom-control custom-checkbox">
              <input class="custom-control-input" type="checkbox" id="show-title" checked>
              <label class="custom-control-label" for="show-title">タイトル</label>
            </div>
            <div class="custom-control custom-checkbox">
              <input class="custom-control-input" type="checkbox" id="show-channel" checked>
              <label class="custom-control-label" for="show-channel">チャンネル名</label>
            </div>
          </div>
        </div>

        <div class="mb-2">
          <div id="grid-hint" class="small-muted"></div>
          <input type="hidden" id="share-grid" value="">
          <div id="grid-buttons" class="mt-1"></div>
        </div>

        <div class="mt-3">
          <img id="share-preview-img" class="share-preview" alt="preview" src="">
          <div class="small-muted mt-1">
            プレビューは「現在の選択（種別＋グリッド＋表示）」で自動更新されます。
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Results -->
    <div class="card results-card">
      <div class="card-body">
        <div class="section-title">検索結果</div>
        <div class="small-muted mb-2">
          表は各列ソート可能（クリックで昇順/降順）
        </div>

        {% macro render_table(rows, kind_label) %}
          {% if rows and rows|length > 0 %}
            <h5 class="mt-4">{{ kind_label }}（{{ rows|length }}件）</h5>
            <div class="table-responsive">
              <table class="table table-bordered table-sm fav-table gap-compact">
                <thead>
                  <tr>
                    <th>投稿日時</th>
                    <th>タイトル</th>
                    <th>概要</th>
                    <th>再生数</th>
                    <th>高評価</th>
                    <th>コメント数</th>
                    <th>動画時間</th>
                    <th>サムネ</th>
                    <th>URL</th>
                    <th>チャンネル</th>
                    <th>登録者</th>
                    <th>チャンネルURL</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in rows %}
                    <tr>
                      <td class="nowrap" data-sort-value="{{ row.get('publishedAtSort', 0) }}">{{ row.get('publishedAt','') }}</td>
                      <td><div class="text-content">{{ row.get('title','') }}</div></td>
                      <td><div class="text-content">{{ row.get('description','') }}</div></td>

                      <td class="nowrap" data-sort-value="{{ row.get('viewCount',0)|int }}">{{ "{:,}".format(row.get('viewCount',0)|int) }}</td>
                      <td class="nowrap" data-sort-value="{{ row.get('likeCount',0)|int }}">{{ "{:,}".format(row.get('likeCount',0)|int) }}</td>

                      <td class="nowrap" data-sort-value="{{ row.get('commentCount',0)|int }}">
                        {{ "{:,}".format(row.get('commentCount',0)|int) }}
                      </td>

                      <td class="nowrap">{{ row.get('videoDuration','') }}</td>

                      <td class="nowrap">
                        {% set t = row.get('thumbnails','') %}
                        {% if t %}
                          <a href="{{ t }}" target="_blank" rel="noopener"><img class="thumb-img" src="{{ t }}"></a>
                        {% endif %}
                      </td>

                      <td class="nowrap">
                        {% set u = row.get('video_url','') %}
                        {% if u %}
                          <a href="{{ u }}" target="_blank" rel="noopener">open</a>
                        {% endif %}
                      </td>

                      <td class="nowrap"><div class="text-content">{{ row.get('name','') }}</div></td>

                      <td class="nowrap" data-sort-value="{{ row.get('subscriberCount',0)|int }}">{{ "{:,}".format(row.get('subscriberCount',0)|int) }}</td>

                      <td class="nowrap">
                          {% set ch = row.get('channel_icon') or [] %}
                          {% set cu = ch[1] if ch|length > 1 else '' %}
                        {% if cu %}
                          <a href="{{ cu }}" target="_blank" rel="noopener">channel</a>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}
        {% endmacro %}

        {{ render_table(normal_rows, "通常動画") }}
        {{ render_table(short_rows, "ショート") }}

        {% if (not normal_rows or normal_rows|length==0) and (not short_rows or short_rows|length==0) %}
          <div class="small-muted mt-3">検索結果はまだありません。</div>
        {% endif %}
      </div>
    </div>

  </div>

  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"
          integrity="sha384-vjEe1m8U6mY7n0eMbh+e9pF7QvQp4s1zAb9YSEuxsjjXNpMOG66Q6VbUaz2QmiFj"
          crossorigin="anonymous"></script>
</body>
</html>

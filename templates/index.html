<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ title }}</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background:#fafafa; }
    .container-wide { max-width: 1400px; }
    details.sticky {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: #fff;
      border: 1px solid #e3e3e3;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
      padding: 10px 12px;
      margin-bottom: 14px;
    }
    details.sticky[open] {
      max-height: 60vh;
      overflow: auto;
    }
    details.sticky summary {
      cursor: pointer;
      user-select: none;
      font-weight: 700;
    }
    .table thead th { white-space: nowrap; cursor: pointer; }
    .nowrap { white-space: nowrap; }
    .thumb-sm { width: 92px; height: 52px; object-fit: contain; background:#eee; border-radius: 8px; }
    .badge-soft { background:#f2f2f2; color:#333; border:1px solid #e0e0e0; }
    .share-preview {
      max-width: 100%;
      border-radius: 12px;
      border: 1px solid #e1e1e1;
      background: #fff;
    }
    .grid-btn.active {
      border-color: #0d6efd !important;
      box-shadow: 0 0 0 .2rem rgba(13,110,253,.15);
    }
    .small-muted { font-size: 12px; color:#666; }
  </style>
</head>
<body>
  <div class="container container-wide py-3">

    <details id="search-details" class="sticky" open>
      <summary>検索フォーム（クリックで開閉）</summary>
      <div class="mt-3">
        <form action="/scraping" method="get" class="row g-2 align-items-end">
          <div class="col-12 col-md-6">
            <label class="form-label">キーワード</label>
            <input class="form-control" name="word" value="{{ form.word }}" placeholder="例：ジョジョランズ">
          </div>

          <div class="col-6 col-md-3">
            <label class="form-label">From</label>
            <input class="form-control" name="from" value="{{ form.from }}" placeholder="2025-12-01T00:00:00Z">
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">To</label>
            <input class="form-control" name="to" value="{{ form.to }}" placeholder="2025-12-27T00:00:00Z">
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Channel ID（任意）</label>
            <input class="form-control" name="channel-id" value="{{ form.channel_id }}" placeholder="UCxxxx">
          </div>

          <div class="col-6 col-md-2">
            <label class="form-label">並び順</label>
            <select class="form-select" name="order">
              <option value="date" {% if form.order=="date" %}selected{% endif %}>date</option>
              <option value="relevance" {% if form.order=="relevance" %}selected{% endif %}>relevance</option>
              <option value="viewCount" {% if form.order=="viewCount" %}selected{% endif %}>viewCount</option>
            </select>
          </div>

          <div class="col-6 col-md-2">
            <label class="form-label">取得件数</label>
            <input class="form-control" name="video-count" value="{{ form.video_count }}" placeholder="200">
          </div>

          <div class="col-6 col-md-2">
            <label class="form-label">視聴 min</label>
            <input class="form-control" name="viewcount-level" value="{{ form.viewcount_min }}" placeholder="">
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label">視聴 max</label>
            <input class="form-control" name="viewcount-max" value="{{ form.viewcount_max }}" placeholder="">
          </div>

          <div class="col-6 col-md-2">
            <label class="form-label">登録 min</label>
            <input class="form-control" name="subscribercount-level" value="{{ form.sub_min }}" placeholder="">
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label">登録 max</label>
            <input class="form-control" name="subscribercount-max" value="{{ form.sub_max }}" placeholder="">
          </div>

          <div class="col-12 col-md-2">
            <label class="form-label">検索対象</label>
            <select class="form-select" name="video-kind">
              <option value="" {% if not form.video_kind %}selected{% endif %}>（両方）</option>
              <option value="normal" {% if form.video_kind=="normal" %}selected{% endif %}>通常動画</option>
              <option value="shorts" {% if form.video_kind=="shorts" %}selected{% endif %}>ショート</option>
            </select>
          </div>

          <div class="col-12 col-md-2">
            <button class="btn btn-primary w-100" type="submit">検索</button>
          </div>
        </form>
      </div>
    </details>

    {% if sorce and sorce[0].get("error") %}
      <div class="alert alert-danger">
        <div class="fw-bold">YouTube API エラー</div>
        <div class="small">{{ sorce[0].get("error") }}</div>
      </div>
    {% endif %}

    <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
      <div class="badge rounded-pill badge-soft">結果: {{ sorce|length }} 件</div>
      {% if share_sid %}
        <div class="badge rounded-pill badge-soft">
          まとめ画像対象: 通常 {{ share_counts.normal }} / ショート {{ share_counts.shorts }} / 合計 {{ share_counts.all }}
        </div>
      {% endif %}
    </div>

    <!-- Results table -->
    <div class="table-responsive bg-white border rounded-3">
      <table id="result-table" class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th data-key="_idx">No</th>
            <th data-key="publishedAt">投稿日時</th>
            <th data-key="title">タイトル</th>
            <th data-key="name">チャンネル</th>
            <th data-key="viewCount">視聴</th>
            <th data-key="likeCount">Like</th>
            <th data-key="commentCount">コメ</th>
            <th class="nowrap">サムネ</th>
            <th class="nowrap">URL</th>
          </tr>
        </thead>
        <tbody>
          {% for row in sorce %}
            <tr>
              <td class="nowrap" data-sort="{{ loop.index }}">{{ loop.index }}</td>
              <td class="nowrap" data-sort="{{ row.get('publishedAt','') }}">{{ row.get('publishedAt','') }}</td>
              <td data-sort="{{ row.get('title','') }}">{{ row.get('title','') }}</td>
              <td data-sort="{{ row.get('name','') }}">{{ row.get('name','') }}</td>
              <td class="nowrap text-end" data-sort="{{ row.get('viewCount',0)|int }}">{{ "{:,}".format(row.get('viewCount',0)|int) }}</td>
              <td class="nowrap text-end" data-sort="{{ row.get('likeCount',0)|int }}">{{ "{:,}".format(row.get('likeCount',0)|int) }}</td>
              <td class="nowrap text-end" data-sort="{{ row.get('commentCount',0)|int }}">{{ "{:,}".format(row.get('commentCount',0)|int) }}</td>
              <td class="nowrap">
                {% if row.get("thumbnails") %}
                  <img class="thumb-sm" src="{{ row.get('thumbnails') }}" alt="thumb">
                {% endif %}
              </td>
              <td class="nowrap">
                {% if row.get("video_url") %}
                  <a href="{{ row.get('video_url') }}" target="_blank" rel="noopener">open</a>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Share image -->
    <div id="share-panel"
         class="mt-3 p-3 bg-white border rounded-3"
         data-share-sid="{{ share_sid }}"
         data-count-all="{{ share_counts.all }}"
         data-count-normal="{{ share_counts.normal }}"
         data-count-shorts="{{ share_counts.shorts }}">
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <div class="fw-bold">X用まとめ画像（サムネ一覧）</div>
        <div class="small-muted">ショートは縦長。通常と別出力が推奨。</div>
      </div>

      {% if not share_sid %}
        <div class="small text-muted mt-2">検索後に使えます。</div>
      {% else %}
      <div class="row g-3 mt-1">
        <div class="col-12 col-lg-5">
          <div class="border rounded-3 p-2">
            <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
              <label class="form-label mb-0">出力種別</label>
              <div class="btn-group btn-group-sm" role="group" aria-label="kind">
                <button type="button" class="btn btn-outline-primary" id="kind-normal">通常</button>
                <button type="button" class="btn btn-outline-primary" id="kind-shorts">ショート</button>
              </div>
              <div class="ms-auto small-muted" id="kind-count"></div>
            </div>

            <div class="row g-2">
              <div class="col-6">
                <label class="form-label">出力幅(px)</label>
                <select id="share-w" class="form-select form-select-sm">
                  <option value="1200">1200</option>
                  <option value="1600" selected>1600</option>
                  <option value="2000">2000</option>
                  <option value="2400">2400</option>
                  <option value="3000">3000</option>
                  <option value="4000">4000</option>
                </select>
              </div>

              <div class="col-6">
                <label class="form-label">枚数(n)</label>
                <input id="share-n" type="number" class="form-control form-control-sm" min="1" step="1">
              </div>

              <div class="col-6">
                <label class="form-label">間隔(gap)</label>
                <input id="share-gap" type="number" class="form-control form-control-sm" min="0" max="50" step="1" value="8">
              </div>

              <div class="col-6">
                <label class="form-label">狙う比率(横/縦)</label>
                <select id="share-target" class="form-select form-select-sm">
                  <option value="1.000">1:1（正方形）</option>
                  <option value="0.800">4:5（Xに強い）</option>
                  <option value="1.250">5:4</option>
                  <option value="1.333">4:3</option>
                  <option value="1.777" selected>16:9（横長）</option>
                  <option value="0.5625">9:16（縦長）</option>
                </select>
              </div>

              <div class="col-12">
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="checkbox" id="show-title" checked>
                  <label class="form-check-label" for="show-title">タイトル</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="checkbox" id="show-channel">
                  <label class="form-check-label" for="show-channel">チャンネル名</label>
                </div>
              </div>
            </div>

            <hr class="my-2">

            <div class="small-muted mb-1">約数グリッド（選ぶとプレビュー更新）</div>
            <div id="grid-list" class="d-flex flex-wrap gap-2"></div>

            <div class="d-flex flex-wrap gap-2 mt-3">
              <button id="btn-preview" type="button" class="btn btn-sm btn-outline-secondary">プレビュー更新</button>
              <button id="btn-open" type="button" class="btn btn-sm btn-primary">この種別で開く</button>
              <button id="btn-open-normal" type="button" class="btn btn-sm btn-outline-primary">通常を開く</button>
              <button id="btn-open-shorts" type="button" class="btn btn-sm btn-outline-primary">ショートを開く</button>
            </div>

            <div class="small-muted mt-2">
              ※ ショートはサムネに左右黒ベタが付くことがあるので、自動で除去して表示します。
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-7">
          <div class="small-muted mb-2">プレビュー（開く前に確認用）</div>
          <img id="share-preview" class="share-preview" alt="preview" />
        </div>
      </div>
      {% endif %}
    </div>

  </div>

  <script>
    // ---- Sticky details: toggleするとそこへスクロール ----
    (function(){
      const d = document.getElementById('search-details');
      if (!d) return;
      d.addEventListener('toggle', () => {
        d.scrollIntoView({behavior: 'smooth', block: 'start'});
      });
    })();

    // ---- Table sort (simple) ----
    (function(){
      const table = document.getElementById('result-table');
      if (!table) return;
      const tbody = table.querySelector('tbody');
      const headers = table.querySelectorAll('thead th[data-key]');
      let sortKey = null;
      let sortAsc = true;

      function getCellSortValue(tr, key){
        if (key === '_idx') return parseInt(tr.children[0].dataset.sort || '0', 10) || 0;
        const map = {
          publishedAt: 1, title: 2, name: 3, viewCount: 4, likeCount: 5, commentCount: 6
        };
        const idx = map[key];
        if (idx === undefined) return '';
        const td = tr.children[idx];
        const v = td ? (td.dataset.sort || td.textContent || '') : '';
        // numeric?
        if (key === 'viewCount' || key === 'likeCount' || key === 'commentCount') {
          return parseInt(String(v).replace(/,/g,''), 10) || 0;
        }
        return v;
      }

      function sortBy(key){
        if (sortKey === key) sortAsc = !sortAsc;
        else { sortKey = key; sortAsc = true; }

        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort((a,b) => {
          const va = getCellSortValue(a, key);
          const vb = getCellSortValue(b, key);
          if (typeof va === 'number' && typeof vb === 'number') return sortAsc ? (va-vb) : (vb-va);
          return sortAsc ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
        });
        rows.forEach(r => tbody.appendChild(r));
      }

      headers.forEach(th => th.addEventListener('click', () => sortBy(th.dataset.key)));
    })();

    // ---- Share image UI ----
    (function(){
      const panel = document.getElementById('share-panel');
      if (!panel) return;

      const sid = panel.dataset.shareSid || '';
      const counts = {
        all: parseInt(panel.dataset.countAll || '0', 10) || 0,
        normal: parseInt(panel.dataset.countNormal || '0', 10) || 0,
        shorts: parseInt(panel.dataset.countShorts || '0', 10) || 0,
      };
      if (!sid) return;

      const kindBtns = {
        normal: document.getElementById('kind-normal'),
        shorts: document.getElementById('kind-shorts'),
      };
      const kindCount = document.getElementById('kind-count');

      const wSel = document.getElementById('share-w');
      const nInput = document.getElementById('share-n');
      const gapInput = document.getElementById('share-gap');
      const targetSel = document.getElementById('share-target');
      const showTitle = document.getElementById('show-title');
      const showChannel = document.getElementById('show-channel');

      const gridList = document.getElementById('grid-list');
      const previewImg = document.getElementById('share-preview');

      const btnPreview = document.getElementById('btn-preview');
      const btnOpen = document.getElementById('btn-open');
      const btnOpenNormal = document.getElementById('btn-open-normal');
      const btnOpenShorts = document.getElementById('btn-open-shorts');

      const state = {
        kind: 'normal',
        grid: { rows: 0, cols: 0 },
      };

      function cellRatio(kind){
        // w/h
        return (kind === 'shorts') ? (9/16) : (16/9);
      }

      function factors(n){
        const out = [];
        for (let r=1; r<=n; r++){
          if (n % r === 0){
            out.push([r, n/r]);
          }
        }
        return out;
      }

      function pickBest(pairs, target, kind){
        const cr = cellRatio(kind);
        let best = null;
        let bestScore = Infinity;

        for (const [r,c] of pairs){
          const ratio = (c / r) * cr;
          const score = Math.abs(ratio - target);
          if (score < bestScore){
            bestScore = score;
            best = { rows: r, cols: c, ratio };
          }
        }
        return best;
      }

      function setActiveKind(kind){
        state.kind = kind;
        kindBtns.normal.classList.toggle('active', kind === 'normal');
        kindBtns.shorts.classList.toggle('active', kind === 'shorts');

        const total = counts[kind] || 0;
        // no items for this kind
        if (total <= 0){
          kindCount.textContent = `対象: 0 件`;
          nInput.max = '1';
          nInput.value = '1';
          gridList.innerHTML = '<div class="small text-muted">この種別の結果がありません</div>';
          previewImg.removeAttribute('src');
          btnOpen.disabled = true;
          btnPreview.disabled = true;
          return;
        }
        btnOpen.disabled = false;
        btnPreview.disabled = false;
        kindCount.textContent = `対象: ${total} 件`;
        nInput.max = String(Math.max(1, total));
        if (!nInput.value) nInput.value = String(Math.min(12, total));
        else {
          const v = Math.min(parseInt(nInput.value || '1', 10) || 1, total);
          nInput.value = String(Math.max(1, v));
        }

        // default target: normal -> 16:9, shorts -> 4:5
        if (kind === 'shorts' && targetSel.value === '1.777') targetSel.value = '0.800';

        renderGrid();
        refreshPreview();
      }

      function renderGrid(){
        const kind = state.kind;
        const total = counts[kind] || 0;
        const n = Math.min(parseInt(nInput.value || '1', 10) || 1, total);
        const pairs = factors(total).filter(([r,c]) => (r*c) >= n);

        gridList.innerHTML = '';

        const target = parseFloat(targetSel.value || '1.777');
        const best = pickBest(pairs, target, kind) || {rows:1, cols: Math.max(1, total), ratio: cellRatio(kind) * total};

        state.grid = {rows: best.rows, cols: best.cols};

        for (const [r,c] of pairs){
          const cr = cellRatio(kind);
          const ratio = (c/r) * cr;
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn btn-sm btn-outline-secondary grid-btn';
          btn.textContent = `${c}×${r} (${ratio.toFixed(3)})`;
          if (r === state.grid.rows && c === state.grid.cols) btn.classList.add('active');

          btn.addEventListener('click', () => {
            state.grid = {rows: r, cols: c};
            // update active styles
            Array.from(gridList.querySelectorAll('.grid-btn')).forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            refreshPreview();
          });

          gridList.appendChild(btn);
        }
      }

      function buildUrl(kind){
        const total = counts[kind] || 0;
        const n = Math.min(parseInt(nInput.value || '1', 10) || 1, total);
        const rows = state.grid.rows || 1;
        const cols = state.grid.cols || total || 1;

        const params = new URLSearchParams();
        params.set('sid', sid);
        params.set('kind', kind);
        params.set('n', String(n));
        params.set('rows', String(rows));
        params.set('cols', String(cols));
        params.set('w', wSel.value || '1600');
        params.set('gap', gapInput.value || '8');
        params.set('show_title', showTitle.checked ? '1' : '0');
        params.set('show_channel', showChannel.checked ? '1' : '0');

        return `/share_image?${params.toString()}`;
      }

      function refreshPreview(){
        const url = buildUrl(state.kind);
        previewImg.src = url + `&ts=${Date.now()}`;
      }

      // events
      kindBtns.normal.addEventListener('click', () => setActiveKind('normal'));
      kindBtns.shorts.addEventListener('click', () => setActiveKind('shorts'));

      [wSel, nInput, gapInput, targetSel, showTitle, showChannel].forEach(el => {
        el.addEventListener('change', () => { renderGrid(); refreshPreview(); });
      });

      btnPreview.addEventListener('click', () => refreshPreview());
      btnOpen.addEventListener('click', () => window.open(buildUrl(state.kind), '_blank'));
      btnOpenNormal.addEventListener('click', () => window.open(buildUrl('normal'), '_blank'));
      btnOpenShorts.addEventListener('click', () => window.open(buildUrl('shorts'), '_blank'));

      // init
      setActiveKind('normal');
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>{{ title }}</title>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
        crossorigin="anonymous">

  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/js/jquery.tablesorter.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/css/theme.default.min.css">

  <style>
    /* Sticky search area (è¿½å¾“) */
    #sticky-search {
      position: sticky;
      top: 0;
      z-index: 2000;
      background: #fff;
      border-bottom: 1px solid #e6e6e6;
      padding-top: 10px;
      padding-bottom: 10px;
    }

    #fav-table th { background-color: pink; }
    .text-content { max-height: 100px; overflow-y: auto; }
    .nowrap { white-space: nowrap; }
    .small-muted { color:#777; font-size:12px; }
    .grid-btns button { margin-right: 6px; margin-bottom: 6px; }
    details summary { cursor: pointer; }
    .preview-img { max-width:100%; border:1px solid #ddd; }
    .badge-soft { background:#f2f2f2; padding:2px 6px; border-radius:6px; }
  </style>

  <script>
    $(document).ready(function() {
      // URL icon + hashtag linkify (cell-only)
      $('.text-content').each(function() {
        var exp = /(https:\/\/www\.youtube\.com\/(watch|shorts)[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
        var exp_hash = /#+([a-zA-Z0-9äºœ-ç†™ã-ã‚“ã‚¡-ãƒ¶ãƒ¼-é¾¥ï¤©-ï¨­.\-_]+)/g;

        var txt = $(this).html();
        txt = txt.replace(exp, "<a href='$1' target='_blank' rel='noopener'>ğŸ”—</a>");
        txt = txt.replace(exp_hash, "<a href='https://www.youtube.com/hashtag/$1' target='_blank' rel='noopener'>#$1</a>");
        $(this).html(txt);
      });

      $('#fav-table').tablesorter();

      // details open/close -> scroll to form
      const det = document.getElementById("search-details");
      if (det) {
        det.addEventListener("toggle", () => {
          det.scrollIntoView({behavior:"smooth", block:"start"});
        });
      }
    });
  </script>
</head>

<body>
  <div class="container-fluid">

    <!-- Sticky Search (è¿½å¾“) -->
    <div id="sticky-search">
      <details id="search-details" open>
        <summary class="h5 mb-2">æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆé–‹é–‰ï¼‰</summary>

        <form method="GET" action="/scraping" class="border rounded p-2 mb-2">
          <div class="form-row">
            <div class="col-md-3 mb-2">
              <label class="small mb-1">æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰</label>
              <input type="text" class="form-control" name="word" value="{{ form.word|default('') }}">
            </div>
            <div class="col-md-2 mb-2">
              <label class="small mb-1">from</label>
              <input type="date" class="form-control" name="from" value="{{ form.from|default('') }}">
            </div>
            <div class="col-md-2 mb-2">
              <label class="small mb-1">to</label>
              <input type="date" class="form-control" name="to" value="{{ form.to|default('') }}">
            </div>
            <div class="col-md-3 mb-2">
              <label class="small mb-1">ãƒãƒ£ãƒ³ãƒãƒ«ID / URL</label>
              <input type="text" class="form-control" name="channel-id" value="{{ form.channel_id|default('') }}">
            </div>
            <div class="col-md-2 mb-2">
              <label class="small mb-1">å–å¾—ä»¶æ•°</label>
              <input type="number" class="form-control" name="video-count" value="{{ form.video_count|default('200') }}">
            </div>
          </div>

          <div class="form-row">
            <div class="col-md-2 mb-2">
              <label class="small mb-1">å†ç”Ÿæ•° ä¸‹é™</label>
              <input type="number" class="form-control" name="viewcount-level" value="{{ form.viewcount_min|default('') }}">
            </div>
            <div class="col-md-2 mb-2">
              <label class="small mb-1">å†ç”Ÿæ•° ä¸Šé™</label>
              <input type="number" class="form-control" name="viewcount-max" value="{{ form.viewcount_max|default('') }}">
            </div>
            <div class="col-md-2 mb-2">
              <label class="small mb-1">ç™»éŒ²è€… ä¸‹é™</label>
              <input type="number" class="form-control" name="subscribercount-level" value="{{ form.sub_min|default('') }}">
            </div>
            <div class="col-md-2 mb-2">
              <label class="small mb-1">ç™»éŒ²è€… ä¸Šé™</label>
              <input type="number" class="form-control" name="subscribercount-max" value="{{ form.sub_max|default('') }}">
            </div>
            <div class="col-md-2 mb-2">
              <label class="small mb-1">ä¸¦ã³é †</label>
              <select class="form-control" name="order">
                <option value="date" {% if form.order|default('date') == 'date' %}selected{% endif %}>æ–°ã—ã„é †</option>
                <option value="viewcount" {% if form.order|default('date') == 'viewcount' %}selected{% endif %}>å†ç”Ÿæ•°é †</option>
              </select>
            </div>            <div class="col-md-2 mb-2">
              <label class="small mb-1">å¯¾è±¡ï¼ˆç©º=ä¸¡æ–¹ï¼‰</label>
              <select class="form-control" name="video-type">
                <option value="" {% if form.video_type|default('') == '' %}selected{% endif %}></option>
                <option value="normal" {% if form.video_type|default('') == 'normal' %}selected{% endif %}>é€šå¸¸</option>
                <option value="shorts" {% if form.video_type|default('') == 'shorts' %}selected{% endif %}>ã‚·ãƒ§ãƒ¼ãƒˆ</option>
              </select>
              <div class="small-muted">â€»ã‚·ãƒ§ãƒ¼ãƒˆåˆ¤å®šã¯ã€Œ/shorts/ URLã«ãªã‚‹ã‹ã€ã§åˆ¤å®šï¼ˆé•·ã•ã ã‘ã§ã¯åˆ¤å®šã—ã¾ã›ã‚“ï¼‰</div>
            </div>

            <div class="col-md-2 mb-2 d-flex align-items-end">
              <button type="submit" class="btn btn-primary btn-block">æ¤œç´¢</button>
            </div>
          </div>

          {% if font_hint %}
            <div class="small-muted">{{ font_hint }}</div>
          {% endif %}
        </form>
      </details>
    </div>

    <div class="card-body p-0 mt-2">
      <div class="p-2">
        æ¤œç´¢çµæœ: {{ sorce | length }}ä»¶
        {% if share_counts.total %}
          <span class="badge-soft ml-2">é€šå¸¸ {{ share_counts.normal }}</span>
          <span class="badge-soft ml-1">ã‚·ãƒ§ãƒ¼ãƒˆ {{ share_counts.short }}</span>
        {% endif %}
      </div>

      <table id="fav-table" class="table table-bordered table-sm">
        <thead>
          <tr>
            <th>æŠ•ç¨¿æ—¥æ™‚</th>
            <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
            <th>æ¦‚è¦</th>
            <th>å†ç”Ÿæ•°</th>
            <th>é«˜è©•ä¾¡æ•°</th>
            <th>ã‚³ãƒ¡ãƒ³ãƒˆæ•°</th>
            <th>å‹•ç”»æ™‚é–“</th>
            <th>ã‚µãƒ ãƒ</th>
            <th>URL</th>
            <th>ãƒãƒ£ãƒ³ãƒãƒ«å</th>
            <th>ç™»éŒ²è€…æ•°</th>
            <th>ãƒãƒ£ãƒ³ãƒãƒ«</th>
          </tr>
        </thead>
        <tbody>
        {% for row in sorce %}
          <tr>
            <td class="nowrap">{{ row.get('publishedAt','') }}</td>
            <td><div class="text-content">{{ row.get('title','')|safe }}</div></td>
            <td><div class="text-content">{{ row.get('description','')|safe }}</div></td>
            <td class="nowrap" data-sort-value="{{ row.get('viewCount',0)|int }}">{{ "{:,}".format(row.get('viewCount',0)|int) }}</td>
            <td class="nowrap" data-sort-value="{{ row.get('likeCount',0)|int }}">{{ "{:,}".format(row.get('likeCount',0)|int) }}</td>
            <td class="nowrap" data-sort-value="{{ row.get('commentCount',0)|int }}">
              {% set vurl = row.get('video_url','') %}
              <a href="/comment?video-id={{ vurl }}" target="_blank" rel="noopener">{{ "{:,}".format(row.get('commentCount',0)|int) }}</a>
            </td>
            <td class="nowrap">{{ row.get('videoDuration','') }}</td>
            <td class="nowrap">
              {% set th = row.get('thumbnails','') %}
              {% if th %}
                <a href="{{ th }}" target="_blank" rel="noopener"><img src="{{ th }}" height="60"></a>
              {% endif %}
            </td>
            <td><div class="text-content">{{ row.get('video_url','')|safe }}</div></td>
            <td class="nowrap">{{ row.get('name','') }}</td>
            <td class="nowrap" data-sort-value="{{ row.get('subscriberCount',0)|int }}">{{ "{:,}".format(row.get('subscriberCount',0)|int) }}</td>
            <td class="nowrap">
              {% set ch = row.get('channel_icon', []) %}
              {% if ch and ch|length >= 1 %}
                <a href="{{ ch[0] }}" target="_blank" rel="noopener">link</a>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    {% if share_sid and (sorce|length) > 0 %}
    <hr>
    <div id="share-panel" class="card p-3"
         data-sid="{{ share_sid }}"
         data-total="{{ share_counts.total }}"
         data-normal="{{ share_counts.normal }}"
         data-short="{{ share_counts.short }}">
      <div class="d-flex align-items-center justify-content-between">
        <h5 class="mb-2">Xç”¨ã¾ã¨ã‚ç”»åƒ</h5>
        <div class="small-muted">åˆè¨ˆ {{ share_counts.total }} ä»¶ï¼ˆé€šå¸¸ {{ share_counts.normal }} / ã‚·ãƒ§ãƒ¼ãƒˆ {{ share_counts.short }}ï¼‰</div>
      </div>

      <div class="form-row">
        <div class="col-auto">
          <label class="small mb-1">è¡¨ç¤ºé …ç›®</label><br>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="opt-title" checked>
            <label class="form-check-label small" for="opt-title">å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="opt-channel" checked>
            <label class="form-check-label small" for="opt-channel">ãƒãƒ£ãƒ³ãƒãƒ«å</label>
          </div>
        </div>

        <div class="col-auto">
          <label class="small mb-1">ã‚·ãƒ§ãƒ¼ãƒˆ</label><br>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="opt-separate" checked>
            <label class="form-check-label small" for="opt-separate">é€šå¸¸/ã‚·ãƒ§ãƒ¼ãƒˆã‚’åˆ†ã‘ã‚‹</label>
          </div>
        </div>

        <div class="col-auto">
          <label class="small mb-1">æ¨å¥¨åŸºæº–</label>
          <select id="share-target" class="form-control form-control-sm">
            <option value="1.7777777778">16:9ï¼ˆè¦‹åˆ‡ã‚Œã«ãã„ï¼‰</option>
            <option value="1.91">1.91:1ï¼ˆæ¨ªé•·ï¼‰</option>
            <option value="0.8">4:5ï¼ˆç¸¦é•·ï¼‰</option>
          </select>
        </div>

        <div class="col-auto">
          <label class="small mb-1">å‡ºåŠ›å¹…</label>
          <select id="share-w" class="form-control form-control-sm">
            <option value="1600">1600px</option>
            <option value="1200">1200px</option>
            <option value="2000">2000px</option>
          </select>
        </div>
          <div class="col-md-2 mb-2">
            <label class="small mb-1">é–“éš”(px)</label>
            <input type="number" class="form-control form-control-sm" id="share-gap" value="4" min="0" max="40">
          </div>
      </div>

      <!-- Mixed mode -->
      <div id="mixed-controls" class="mt-3">
        <div class="small-muted mb-1">ï¼ˆæ··åœ¨ï¼‰å¯¾è±¡ä»¶æ•° nï¼ˆç´„æ•°å€™è£œï¼‰</div>
        <div class="form-row">
          <div class="col-auto">
            <input id="share-n" type="number" class="form-control form-control-sm"
                   min="1" max="{{ share_counts.total }}"
                   value="{{ share_counts.total if share_counts.total<=60 else 60 }}">
          </div>
        </div>
        <div class="mt-2">
          <div class="small-muted mb-1">è¡ŒÃ—åˆ—ï¼ˆç´„æ•°/è¿‘ä¼¼å€™è£œï¼‰</div>
          <div id="share-grid-list" class="grid-btns"></div>
          <div id="share-reco" class="small-muted mt-2"></div>
          <div class="small-muted mt-1">é¸æŠä¸­ï¼š<span id="share-selected">-</span></div>
        </div>
      </div>

      <!-- Separate mode -->
      <div id="sep-controls" class="mt-3" style="display:none;">
        <div class="row">
          <div class="col-md-6">
            <h6>é€šå¸¸</h6>
            <div class="small-muted mb-1">å¯¾è±¡ä»¶æ•° nï¼ˆç´„æ•°å€™è£œï¼‰</div>
            <input id="n-norm" type="number" class="form-control form-control-sm"
                   min="0" max="{{ share_counts.normal }}"
                   value="{{ share_counts.normal if share_counts.normal<=40 else 40 }}">
            <div class="mt-2">
              <div class="small-muted mb-1">è¡ŒÃ—åˆ—</div>
              <div id="grid-norm" class="grid-btns"></div>
              <div id="reco-norm" class="small-muted mt-2"></div>
              <div class="small-muted mt-1">é¸æŠä¸­ï¼š<span id="sel-norm">-</span></div>
            </div>
          </div>
          <div class="col-md-6">
            <h6>ã‚·ãƒ§ãƒ¼ãƒˆ</h6>
            <div class="small-muted mb-1">å¯¾è±¡ä»¶æ•° nï¼ˆç´„æ•°å€™è£œï¼‰</div>
            <input id="n-short" type="number" class="form-control form-control-sm"
                   min="0" max="{{ share_counts.short }}"
                   value="{{ share_counts.short if share_counts.short<=20 else 20 }}">
            <div class="mt-2">
              <div class="small-muted mb-1">è¡ŒÃ—åˆ—</div>
              <div id="grid-short" class="grid-btns"></div>
              <div id="reco-short" class="small-muted mt-2"></div>
              <div class="small-muted mt-1">é¸æŠä¸­ï¼š<span id="sel-short">-</span></div>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-3">
        <a id="share-open" class="btn btn-sm btn-primary" href="#" target="_blank" rel="noopener">ç”»åƒã‚’é–‹ã</a>
      </div>

      <div class="mt-2">
        <img id="share-preview" class="preview-img" alt="preview">
      </div>
    </div>

    <script>
    (function(){
      const panel = document.getElementById("share-panel");
      if(!panel) return;

      const sid = panel.dataset.sid;
      const total = parseInt(panel.dataset.total, 10) || 0;
      const normalTotal = parseInt(panel.dataset.normal, 10) || 0;
      const shortTotal = parseInt(panel.dataset.short, 10) || 0;

      const targetSel = document.getElementById("share-target");
      const wSel = document.getElementById("share-w");
      const gapSel = document.getElementById("share-gap");

      const optTitle = document.getElementById("opt-title");
      const optChannel = document.getElementById("opt-channel");
      const optSeparate = document.getElementById("opt-separate");

      const mixedControls = document.getElementById("mixed-controls");
      const sepControls = document.getElementById("sep-controls");

      // mixed
      const nInput = document.getElementById("share-n");
      const list = document.getElementById("share-grid-list");
      const reco = document.getElementById("share-reco");
      const selectedLabel = document.getElementById("share-selected");

      // separate
      const nNorm = document.getElementById("n-norm");
      const nShort = document.getElementById("n-short");
      const gridNorm = document.getElementById("grid-norm");
      const gridShort = document.getElementById("grid-short");
      const recoNorm = document.getElementById("reco-norm");
      const recoShort = document.getElementById("reco-short");
      const selNorm = document.getElementById("sel-norm");
      const selShort = document.getElementById("sel-short");

      const preview = document.getElementById("share-preview");
      const openBtn = document.getElementById("share-open");

      // thumbnail aspect ratios (width/height)
      const CELL_RATIO_NORMAL = 16/9;
      const CELL_RATIO_SHORT = 9/16;

      // State
      let selectedMixed = null; // [rows, cols]
      let selectedNorm = null;  // [rows, cols]
      let selectedShort = null; // [rows, cols]

      function exactPairs(n){
        const pairs = [];
        for(let r=1; r<=Math.floor(Math.sqrt(n)); r++){
          if(n % r === 0){
            const c = n / r;
            pairs.push([r,c]);
            if(r !== c) pairs.push([c,r]);
          }
        }
        pairs.sort((a,b)=>a[0]-b[0] || a[1]-b[1]);
        return pairs;
      }

      function approxPairs(n){
        const out = [];
        const seen = new Set();
        const maxR = Math.min(n, 24);
        for(let r=1; r<=maxR; r++){
          const c = Math.ceil(n / r);
          const key = r + "x" + c;
          if(!seen.has(key)){
            seen.add(key);
            out.push([r,c]);
          }
        }
        return out;
      }

      function overallRatio(rows, cols, cellRatio){
        // grid width/height = (cols*cellW)/(rows*cellH) -> (cols/rows)*(cellW/cellH) = (cols/rows)*cellRatio
        return (cols/rows) * cellRatio;
      }

      function bestPair(pairs, target, cellRatio){
        let best = null;
        let bestScore = 1e18;
        for(const [r,c] of pairs){
          const ratio = overallRatio(r,c,cellRatio);
          const score = Math.abs(Math.log(ratio / target));
          if(score < bestScore){
            bestScore = score;
            best = [r,c,ratio];
          }
        }
        return best;
      }

      function buildUrlMixed(rows, cols, n, w, gap){
        const showTitle = optTitle.checked ? "1":"0";
        const showChannel = optChannel.checked ? "1":"0";
        return `/share_image?sid=${encodeURIComponent(sid)}&rows=${rows}&cols=${cols}&n=${n}&w=${w}&gap=${gap}&show_title=${showTitle}&show_channel=${showChannel}`;
      }

      function buildUrlSeparate(rn, cn, nn, rs, cs, ns, w, gap){
        const showTitle = optTitle.checked ? "1":"0";
        const showChannel = optChannel.checked ? "1":"0";
        return `/share_image?sid=${encodeURIComponent(sid)}&separate=1`
          + `&rows_norm=${rn}&cols_norm=${cn}&n_norm=${nn}`
          + `&rows_short=${rs}&cols_short=${cs}&n_short=${ns}`
          + `&w=${w}&gap=${gap}&show_title=${showTitle}&show_channel=${showChannel}`;
      }

      function setPreview(url){
        openBtn.href = url;
        preview.src = url;
        preview.scrollIntoView({behavior:"smooth", block:"start"});
      }

      // ---------- Mixed UI ----------
      function renderMixed(){
        const totalCap = Math.max(1, total);
        let n = parseInt(nInput.value, 10) || 1;
        n = Math.max(1, Math.min(n, totalCap));
        nInput.value = n;

        const target = parseFloat(targetSel.value);
        const w = parseInt(wSel.value, 10) || 1600;

        let pairs = exactPairs(n);
        let approx = false;
        if(pairs.length <= 2 && n > 12){
          pairs = approxPairs(n);
          approx = true;
        }

        const best = bestPair(pairs, target, CELL_RATIO_NORMAL);

        if(best){
          const ok = selectedMixed && pairs.some(([r,c])=> r===selectedMixed[0] && c===selectedMixed[1]);
          if(!ok) selectedMixed = [best[0], best[1]];
        } else {
          selectedMixed = null;
        }

        selectedLabel.textContent = selectedMixed ? `${selectedMixed[0]}Ã—${selectedMixed[1]}` : "-";
        reco.textContent = best
          ? `ãŠã™ã™ã‚: ${best[0]}Ã—${best[1]}ï¼ˆæ¨å®š å…¨ä½“æ¯”ç‡ ${best[2].toFixed(2)}:1ï¼‰${approx ? " â€»è¿‘ä¼¼å€™è£œå«ã‚€" : ""}`
          : "";

        list.innerHTML = "";
        pairs.forEach(([r,c])=>{
          const ratio = overallRatio(r,c,CELL_RATIO_NORMAL);
          const btn = document.createElement("button");
          btn.type = "button";

          const isBest = best && r===best[0] && c===best[1];
          const isSel = selectedMixed && r===selectedMixed[0] && c===selectedMixed[1];

          if (isSel && isBest) btn.className = "btn btn-sm btn-success";
          else if (isSel) btn.className = "btn btn-sm btn-info";
          else if (isBest) btn.className = "btn btn-sm btn-outline-success";
          else btn.className = "btn btn-sm btn-outline-secondary";

          btn.textContent = `${r}Ã—${c}`;
          btn.title = `æ¨å®šæ¯”ç‡ ${ratio.toFixed(2)}:1`;
          btn.addEventListener("click", ()=>{
            selectedMixed = [r,c];
            selectedLabel.textContent = `${r}Ã—${c}`;
            setPreview(buildUrlMixed(r,c,n,w));
            renderMixed(); // repaint buttons
          });
          list.appendChild(btn);
        });

        if(selectedMixed){
          setPreview(buildUrlMixed(selectedMixed[0], selectedMixed[1], n, w));
        }
      }

      // ---------- Separate UI ----------
      function renderSeparateGroup(nVal, maxVal, cellRatio, selectedState, gridEl, recoEl, selEl){
        let n = parseInt(nVal.value, 10) || 0;
        n = Math.max(0, Math.min(n, maxVal));
        nVal.value = n;

        if(n === 0){
          gridEl.innerHTML = "";
          recoEl.textContent = "n=0ï¼ˆã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯å‡ºåŠ›ã—ã¾ã›ã‚“ï¼‰";
          selEl.textContent = "-";
          return { n, selected: null, best: null, pairs: [] };
        }

        const target = parseFloat(targetSel.value);
        let pairs = exactPairs(n);
        let approx = false;
        if(pairs.length <= 2 && n > 12){
          pairs = approxPairs(n);
          approx = true;
        }
        const best = bestPair(pairs, target, cellRatio);

        let selected = selectedState;
        if(best){
          const ok = selected && pairs.some(([r,c])=> r===selected[0] && c===selected[1]);
          if(!ok) selected = [best[0], best[1]];
        } else {
          selected = null;
        }

        selEl.textContent = selected ? `${selected[0]}Ã—${selected[1]}` : "-";
        recoEl.textContent = best
          ? `ãŠã™ã™ã‚: ${best[0]}Ã—${best[1]}ï¼ˆæ¨å®š å…¨ä½“æ¯”ç‡ ${best[2].toFixed(2)}:1ï¼‰${approx ? " â€»è¿‘ä¼¼å€™è£œå«ã‚€" : ""}`
          : "";

        gridEl.innerHTML = "";
        pairs.forEach(([r,c])=>{
          const ratio = overallRatio(r,c,cellRatio);
          const btn = document.createElement("button");
          btn.type = "button";

          const isBest = best && r===best[0] && c===best[1];
          const isSel = selected && r===selected[0] && c===selected[1];

          if (isSel && isBest) btn.className = "btn btn-sm btn-success";
          else if (isSel) btn.className = "btn btn-sm btn-info";
          else if (isBest) btn.className = "btn btn-sm btn-outline-success";
          else btn.className = "btn btn-sm btn-outline-secondary";

          btn.textContent = `${r}Ã—${c}`;
          btn.title = `æ¨å®šæ¯”ç‡ ${ratio.toFixed(2)}:1`;
          btn.addEventListener("click", ()=>{
            selected = [r,c];
            selEl.textContent = `${r}Ã—${c}`;
            // caller will re-render + set preview
            const ev = new CustomEvent("gridSelected", { detail: { selected } });
            gridEl.dispatchEvent(ev);
          });
          gridEl.appendChild(btn);
        });

        return { n, selected, best, pairs };
      }

      function renderSeparate(){
        const w = parseInt(wSel.value, 10) || 1600;

        // normal
        const norm = renderSeparateGroup(
          nNorm, normalTotal, CELL_RATIO_NORMAL,
          selectedNorm, gridNorm, recoNorm, selNorm
        );
        selectedNorm = norm.selected;

        // short
        const sh = renderSeparateGroup(
          nShort, shortTotal, CELL_RATIO_SHORT,
          selectedShort, gridShort, recoShort, selShort
        );
        selectedShort = sh.selected;

        const rn = selectedNorm ? selectedNorm[0] : 1;
        const cn = selectedNorm ? selectedNorm[1] : 1;
        const rs = selectedShort ? selectedShort[0] : 1;
        const cs = selectedShort ? selectedShort[1] : 1;

        const url = buildUrlSeparate(rn, cn, norm.n, rs, cs, sh.n, w);
        setPreview(url);
      }

      gridNorm.addEventListener("gridSelected", (e)=>{
        selectedNorm = e.detail.selected;
        renderSeparate();
      });
      gridShort.addEventListener("gridSelected", (e)=>{
        selectedShort = e.detail.selected;
        renderSeparate();
      });

      function modeChanged(){
        const sep = optSeparate.checked;
        mixedControls.style.display = sep ? "none" : "";
        sepControls.style.display = sep ? "" : "none";
        if(sep) renderSeparate(); else renderMixed();
      }

      // listeners
      optTitle.addEventListener("change", modeChanged);
      optChannel.addEventListener("change", modeChanged);
      optSeparate.addEventListener("change", modeChanged);
      nInput.addEventListener("change", renderMixed);
      nNorm.addEventListener("change", renderSeparate);
      nShort.addEventListener("change", renderSeparate);
      targetSel.addEventListener("change", modeChanged);
      wSel.addEventListener("change", modeChanged);

      // init
      modeChanged();
    })();
    </script>
    {% endif %}

  </div>
</body>
</html>

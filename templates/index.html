<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>{{ title }}</title>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
        crossorigin="anonymous">

  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/js/jquery.tablesorter.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/css/theme.default.min.css">

  <style>
    #fav-table th { background-color: pink; }
    .text-content { max-height: 100px; overflow-y: auto; }
    .nowrap { white-space: nowrap; }
    .small-muted { color:#777; font-size:12px; }
    .grid-btns button { margin-right: 6px; margin-bottom: 6px; }
    details summary { cursor: pointer; }
    .preview-img { max-width:100%; border:1px solid #ddd; }
  </style>

  <script>
    $(document).ready(function() {
      // URL icon + hashtag linkify (cell-only)
      $('.text-content').each(function() {
        var exp = /(https:\/\/www\.youtube\.com\/(watch|shorts)[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
        var exp_hash = /#+([a-zA-Z0-9äºœ-ç†™ã-ã‚“ã‚¡-ãƒ¶ãƒ¼-é¾¥ï¤©-ï¨­.\-_]+)/g;

        var txt = $(this).html();
        txt = txt.replace(exp, "<a href='$1' target='_blank' rel='noopener'>ğŸ”—</a>");
        txt = txt.replace(exp_hash, "<a href='https://www.youtube.com/hashtag/$1' target='_blank' rel='noopener'>#$1</a>");
        $(this).html(txt);
      });

      $('#fav-table').tablesorter();

      // details open/close -> scroll to form
      const det = document.getElementById("search-details");
      if (det) {
        det.addEventListener("toggle", () => {
          if (det.open) det.scrollIntoView({behavior:"smooth", block:"start"});
        });
      }
    });
  </script>
</head>

<body>
  <div class="container-fluid mt-3">
    <details id="search-details" open>
      <summary class="h5 mb-2">æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆé–‹é–‰ï¼‰</summary>

      <form method="GET" action="/scraping" class="border rounded p-2 mb-3">
        <div class="form-row">
          <div class="col-md-3 mb-2">
            <label class="small mb-1">æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="text" class="form-control" name="word" value="{{ form.word|default('') }}">
          </div>
          <div class="col-md-2 mb-2">
            <label class="small mb-1">from</label>
            <input type="date" class="form-control" name="from" value="{{ form.from|default('') }}">
          </div>
          <div class="col-md-2 mb-2">
            <label class="small mb-1">to</label>
            <input type="date" class="form-control" name="to" value="{{ form.to|default('') }}">
          </div>
          <div class="col-md-3 mb-2">
            <label class="small mb-1">ãƒãƒ£ãƒ³ãƒãƒ«ID / URL</label>
            <input type="text" class="form-control" name="channel-id" value="{{ form.channel_id|default('') }}">
          </div>
          <div class="col-md-2 mb-2">
            <label class="small mb-1">å–å¾—ä»¶æ•°</label>
            <input type="number" class="form-control" name="video-count" value="{{ form.video_count|default('200') }}">
          </div>
        </div>

        <div class="form-row">
          <div class="col-md-2 mb-2">
            <label class="small mb-1">å†ç”Ÿæ•° ä¸‹é™</label>
            <input type="number" class="form-control" name="viewcount-level" value="{{ form.viewcount_min|default('') }}">
          </div>
          <div class="col-md-2 mb-2">
            <label class="small mb-1">å†ç”Ÿæ•° ä¸Šé™</label>
            <input type="number" class="form-control" name="viewcount-max" value="{{ form.viewcount_max|default('') }}">
          </div>
          <div class="col-md-2 mb-2">
            <label class="small mb-1">ç™»éŒ²è€… ä¸‹é™</label>
            <input type="number" class="form-control" name="subscribercount-level" value="{{ form.sub_min|default('') }}">
          </div>
          <div class="col-md-2 mb-2">
            <label class="small mb-1">ç™»éŒ²è€… ä¸Šé™</label>
            <input type="number" class="form-control" name="subscribercount-max" value="{{ form.sub_max|default('') }}">
          </div>
          <div class="col-md-2 mb-2">
            <label class="small mb-1">ä¸¦ã³é †</label>
            <select class="form-control" name="order">
              <option value="date" {% if form.order|default('date') == 'date' %}selected{% endif %}>æ–°ã—ã„é †</option>
              <option value="viewcount" {% if form.order|default('date') == 'viewcount' %}selected{% endif %}>å†ç”Ÿæ•°é †</option>
            </select>
          </div>
          <div class="col-md-2 mb-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary btn-block">æ¤œç´¢</button>
          </div>
        </div>

        <div class="small-muted">DEBUG share_sid={{ share_sid|default('') }}</div>
      </form>
    </details>

    <div class="card-body p-0">
      <div class="p-2">æ¤œç´¢çµæœ: {{ sorce | length }}ä»¶</div>

      {% set cols = [
        'publishedAt',
        'title',
        'description',
        'viewCount',
        'likeCount',
        'commentCount',
        'videoDuration',
        'thumbnails',
        'video_url',
        'name',
        'subscriberCount',
        'channel_icon'
      ] %}

      <table id="fav-table" class="table table-bordered table-sm">
        <thead>
          <tr>
            <th>æŠ•ç¨¿æ—¥æ™‚</th>
            <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
            <th>æ¦‚è¦</th>
            <th>å†ç”Ÿæ•°</th>
            <th>é«˜è©•ä¾¡æ•°</th>
            <th>ã‚³ãƒ¡ãƒ³ãƒˆæ•°</th>
            <th>å‹•ç”»æ™‚é–“</th>
            <th>ã‚µãƒ ãƒ</th>
            <th>URL</th>
            <th>ãƒãƒ£ãƒ³ãƒãƒ«å</th>
            <th>ç™»éŒ²è€…æ•°</th>
            <th>ãƒãƒ£ãƒ³ãƒãƒ«</th>
          </tr>
        </thead>
        <tbody>
        {% for row in sorce %}
          <tr>
            <td class="nowrap">{{ row.get('publishedAt','') }}</td>
            <td><div class="text-content">{{ row.get('title','')|safe }}</div></td>
            <td><div class="text-content">{{ row.get('description','')|safe }}</div></td>
            <td class="nowrap" data-sort-value="{{ row.get('viewCount',0)|int }}">{{ "{:,}".format(row.get('viewCount',0)|int) }}</td>
            <td class="nowrap" data-sort-value="{{ row.get('likeCount',0)|int }}">{{ "{:,}".format(row.get('likeCount',0)|int) }}</td>
            <td class="nowrap" data-sort-value="{{ row.get('commentCount',0)|int }}">
              {% set vurl = row.get('video_url','') %}
              <a href="/comment?video-id={{ vurl }}" target="_blank" rel="noopener">{{ "{:,}".format(row.get('commentCount',0)|int) }}</a>
            </td>
            <td class="nowrap">{{ row.get('videoDuration','') }}</td>
            <td class="nowrap">
              {% set th = row.get('thumbnails','') %}
              {% if th %}
              <a href="{{ th }}" target="_blank" rel="noopener"><img src="{{ th }}" height="60"></a>
              {% endif %}
            </td>
            <td><div class="text-content">{{ row.get('video_url','')|safe }}</div></td>
            <td class="nowrap">{{ row.get('name','') }}</td>
            <td class="nowrap" data-sort-value="{{ row.get('subscriberCount',0)|int }}">{{ "{:,}".format(row.get('subscriberCount',0)|int) }}</td>
            <td class="nowrap">
              {% set ch = row.get('channel_icon', []) %}
              {% if ch and ch|length >= 1 %}
                <a href="{{ ch[0] }}" target="_blank" rel="noopener">link</a>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    {% if share_sid and (sorce|length) > 0 %}
    <hr>
    <div id="share-panel" class="card p-3"
         data-sid="{{ share_sid }}"
         data-total="{{ sorce|length }}">
      <div class="d-flex align-items-center justify-content-between">
        <h5 class="mb-2">Xç”¨ã¾ã¨ã‚ç”»åƒ</h5>
        <div class="small-muted">åˆè¨ˆ {{ sorce|length }} ä»¶</div>
      </div>

      <div class="form-row">
        <div class="col-auto">
          <label class="small mb-1">å¯¾è±¡ä»¶æ•° n</label>
          <input id="share-n" type="number" class="form-control form-control-sm"
                 min="1" max="{{ sorce|length }}"
                 value="{{ 36 if (sorce|length) >= 36 else (sorce|length) }}">
        </div>

        <div class="col-auto">
          <label class="small mb-1">æ¨å¥¨åŸºæº–</label>
          <select id="share-target" class="form-control form-control-sm">
            <option value="1.7777777778">16:9ï¼ˆè¦‹åˆ‡ã‚Œã«ãã„ï¼‰</option>
            <option value="1.91">1.91:1ï¼ˆæ¨ªé•·ï¼‰</option>
            <option value="0.8">4:5ï¼ˆç¸¦é•·ï¼‰</option>
          </select>
        </div>

        <div class="col-auto">
          <label class="small mb-1">å‡ºåŠ›å¹…</label>
          <select id="share-w" class="form-control form-control-sm">
            <option value="1600">1600px</option>
            <option value="1200">1200px</option>
            <option value="2000">2000px</option>
          </select>
        </div>
      </div>

      <div class="mt-2">
        <div class="small-muted mb-1">è¡ŒÃ—åˆ—ï¼ˆç´„æ•°å€™è£œï¼‰</div>
        <div id="share-grid-list" class="grid-btns"></div>
        <div id="share-reco" class="small-muted mt-2"></div>
      </div>

      <div class="mt-3">
        <a id="share-open" class="btn btn-sm btn-primary" href="#" target="_blank" rel="noopener">ç”»åƒã‚’é–‹ã</a>
      </div>

      <div class="mt-2">
        <img id="share-preview" class="preview-img" alt="preview">
      </div>
    </div>

    <script>
    (function(){
      const panel = document.getElementById("share-panel");
      if(!panel) return;

      const sid = panel.dataset.sid;
      const total = parseInt(panel.dataset.total, 10) || 0;

      const nInput = document.getElementById("share-n");
      const targetSel = document.getElementById("share-target");
      const wSel = document.getElementById("share-w");
      const list = document.getElementById("share-grid-list");
      const reco = document.getElementById("share-reco");
      const preview = document.getElementById("share-preview");
      const openBtn = document.getElementById("share-open");

      // thumbs are 16:9
      const CELL_RATIO = 16/9;

      function exactPairs(n){
        const pairs = [];
        for(let r=1; r<=Math.floor(Math.sqrt(n)); r++){
          if(n % r === 0){
            const c = n / r;
            pairs.push([r,c]);
            if(r !== c) pairs.push([c,r]);
          }
        }
        pairs.sort((a,b)=>a[0]-b[0] || a[1]-b[1]);
        return pairs;
      }

      function approxPairs(n){
        const out = [];
        const seen = new Set();
        const maxR = Math.min(n, 24);
        for(let r=1; r<=maxR; r++){
          const c = Math.ceil(n / r);
          const key = r + "x" + c;
          if(!seen.has(key)){
            seen.add(key);
            out.push([r,c]);
          }
        }
        return out;
      }

      function overallRatio(rows, cols){
        return (cols/rows) * CELL_RATIO;
      }

      function bestPair(pairs, target){
        let best = null;
        let bestScore = 1e18;
        for(const [r,c] of pairs){
          const ratio = overallRatio(r,c);
          const score = Math.abs(Math.log(ratio / target));
          if(score < bestScore){
            bestScore = score;
            best = [r,c,ratio];
          }
        }
        return best;
      }

      function setPreview(r, c, n, w){
        const url = `/share_image?sid=${encodeURIComponent(sid)}&rows=${r}&cols=${c}&n=${n}&w=${w}`;
        openBtn.href = url;
        preview.src = url;
        preview.scrollIntoView({behavior:"smooth", block:"start"});
      }

      function render(){
        let n = parseInt(nInput.value, 10) || 1;
        n = Math.max(1, Math.min(n, total));
        nInput.value = n;

        const target = parseFloat(targetSel.value);
        const w = parseInt(wSel.value, 10) || 1600;

        let pairs = exactPairs(n);
        let approx = false;
        if(pairs.length <= 2 && n > 12){
          pairs = approxPairs(n);
          approx = true;
        }

        const best = bestPair(pairs, target);

        list.innerHTML = "";
        reco.textContent = best
          ? `ãŠã™ã™ã‚: ${best[0]}Ã—${best[1]}ï¼ˆæ¨å®š å…¨ä½“æ¯”ç‡ ${best[2].toFixed(2)}:1ï¼‰${approx ? " â€»è¿‘ä¼¼å€™è£œå«ã‚€" : ""}`
          : "";

        pairs.forEach(([r,c])=>{
          const ratio = overallRatio(r,c);
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "btn btn-sm " + (best && r===best[0] && c===best[1] ? "btn-success" : "btn-outline-secondary");
          btn.textContent = `${r}Ã—${c}`;
          btn.title = `æ¨å®šæ¯”ç‡ ${ratio.toFixed(2)}:1`;
          btn.addEventListener("click", ()=> setPreview(r,c,n,w));
          list.appendChild(btn);
        });

        if(best) setPreview(best[0], best[1], n, w);
      }

      nInput.addEventListener("change", render);
      targetSel.addEventListener("change", render);
      wSel.addEventListener("change", render);
      render();
    })();
    </script>
    {% endif %}
  </div>
</body>
</html>

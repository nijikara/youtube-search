<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>{{ title }}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
        crossorigin="anonymous">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/js/jquery.tablesorter.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/css/theme.default.min.css">

  <style>
    body { background: #fafafa; }
    .sticky-wrap { position: sticky; top: 0; z-index: 999; background: #fafafa; padding-top: .5rem; }
    .card { border-radius: 14px; }
    .form-row-gap > * { margin-right: .5rem; margin-bottom: .5rem; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .nowrap { white-space: nowrap; }
    .text-content { max-height: 110px; overflow-y: auto; }
    .table td { max-width: 420px; vertical-align: top; }
    .kind-badge { font-size: 12px; padding: 2px 8px; border-radius: 999px; background: #eee; }
    .kind-badge.shorts { background:#e8f1ff; color:#0b5bd3; }
    .kind-badge.normal { background:#e9fbe9; color:#1b7f2a; }

    /* grid buttons */
    .grid-btn { margin: 2px; }
    .grid-btn.active { box-shadow: 0 0 0 3px rgba(0,123,255,.25); }
    .share-box { background: #fff; border: 1px solid #e9e9e9; border-radius: 14px; padding: 12px; }
    .share-actions { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .hint { color:#666; font-size: 12px; }

    details summary { cursor:pointer; }
    .divider { height:1px; background:#e9e9e9; margin: 12px 0; }
  </style>

  <script>
    function divisors(n){
      n = parseInt(n,10);
      if(!n || n<=0) return [];
      const out = [];
      for(let a=1; a*a<=n; a++){
        if(n%a===0){
          out.push([a, n/a]);
          if(a!==n/a) out.push([n/a, a]);
        }
      }
      // sort by rows asc then cols asc
      out.sort((p,q)=> (p[0]-q[0]) || (p[1]-q[1]));
      return out;
    }

    function setActiveBtn(container, btn){
      $(container).find('.grid-btn').removeClass('active');
      $(btn).addClass('active');
    }

    function renderGrid(kind){
      const sid = $('#share_sid').val();
      if(!sid) return;

      const total = parseInt($('#count_'+kind).val() || '0', 10);
      const n = parseInt($('#share_n_'+kind).val() || total, 10) || total;
      const baseN = Math.min(n, total);

      const rowsInput = $('#grid_rows_'+kind);
      const colsInput = $('#grid_cols_'+kind);
      const rows = parseInt(rowsInput.val() || '0',10);
      const cols = parseInt(colsInput.val() || '0',10);

      const wrap = $('#grid_btns_'+kind);
      wrap.empty();

      const pairs = divisors(baseN);
      if(pairs.length === 0){
        wrap.append('<span class="hint">（件数が0です）</span>');
        return;
      }

      // 推奨: できるだけ 16:9 に近い (cols/rows) を選ぶ（雑）
      let best = null;
      let bestScore = 1e9;
      const target = (kind==='shorts') ? (9/16) : (16/9); // 画像全体は cols/rows がこれに近いほど横長/縦長の感覚が合う
      pairs.forEach(([r,c])=>{
        const ratio = c / r;
        const score = Math.abs(Math.log(ratio/target));
        if(score < bestScore){
          bestScore = score;
          best = [r,c];
        }
      });

      pairs.forEach(([r,c])=>{
        const btn = $('<button type="button" class="btn btn-sm btn-outline-primary grid-btn"></button>');
        btn.text(`${r}×${c}`);
        btn.on('click', ()=>{
          rowsInput.val(r);
          colsInput.val(c);
          setActiveBtn(wrap, btn);
        });
        wrap.append(btn);
        // 初期選択が無いなら推奨を active
        if((!rows || !cols) && best && best[0]===r && best[1]===c){
          btn.addClass('active');
          rowsInput.val(r);
          colsInput.val(c);
        }
        if(rows===r && cols===c){
          btn.addClass('active');
        }
      });

      $('#grid_hint_'+kind).text(`約数候補: ${baseN}件（推奨: ${best[0]}×${best[1]}）`);
    }

    function buildShareUrl(kind){
      const sid = $('#share_sid').val();
      const total = parseInt($('#count_'+kind).val() || '0', 10);
      const n = parseInt($('#share_n_'+kind).val() || total, 10) || total;
      const rows = parseInt($('#grid_rows_'+kind).val() || '0', 10);
      const cols = parseInt($('#grid_cols_'+kind).val() || '0', 10);

      const showTitle = $('#show_title').is(':checked') ? '1' : '0';
      const showChannel = $('#show_channel').is(':checked') ? '1' : '0';
      const pad = $('#pad').val() || '8';
      const thumbW = ($('#thumb_w').val() || '').trim();

      const qs = new URLSearchParams();
      qs.set('sid', sid);
      qs.set('kind', kind);
      if(rows>0) qs.set('rows', rows);
      if(cols>0) qs.set('cols', cols);
      qs.set('n', Math.min(n, total).toString());
      qs.set('pad', pad);
      if(thumbW) qs.set('thumb_w', thumbW);
      qs.set('show_title', showTitle);
      qs.set('show_channel', showChannel);

      return '/share_image?' + qs.toString();
    }

    $(function(){
      $('#fav-table-normal').tablesorter();
      $('#fav-table-shorts').tablesorter();

      // フォーム開閉 → フォーム位置へスクロール
      $('#toggleForm').on('click', function(){
        const d = document.getElementById('searchFormDetails');
        d.open = !d.open;
        document.getElementById('searchTop').scrollIntoView({behavior:'smooth', block:'start'});
      });

      // グリッド候補を描画
      renderGrid('normal');
      renderGrid('shorts');

      $('#share_n_normal, #grid_rows_normal, #grid_cols_normal').on('input', ()=>renderGrid('normal'));
      $('#share_n_shorts, #grid_rows_shorts, #grid_cols_shorts').on('input', ()=>renderGrid('shorts'));

      $('#shareNormal').on('click', function(){
        window.open(buildShareUrl('normal'), '_blank');
      });
      $('#shareShorts').on('click', function(){
        window.open(buildShareUrl('shorts'), '_blank');
      });
    });
  </script>
</head>

<body>
  <div id="searchTop" class="sticky-wrap">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center">
        <h4 class="mb-2">YouTube検索</h4>
        <button id="toggleForm" class="btn btn-sm btn-outline-secondary">検索フォーム開閉</button>
      </div>

      <details id="searchFormDetails" open>
        <summary class="hint mb-2">ここをクリックでも開閉できます</summary>

        <div class="card mb-3">
          <div class="card-body">
            <form method="GET" action="/scraping">
              <div class="form-row-gap d-flex flex-wrap align-items-end">
                <div>
                  <label class="mb-1">検索ワード</label>
                  <input type="text" class="form-control" name="word" value="{{ form.word }}" style="min-width: 240px;">
                </div>

                <div>
                  <label class="mb-1">From</label>
                  <input type="date" class="form-control" name="from" value="{{ form.from }}">
                </div>
                <div>
                  <label class="mb-1">To</label>
                  <input type="date" class="form-control" name="to" value="{{ form.to }}">
                </div>

                <div>
                  <label class="mb-1">チャンネルID/URL</label>
                  <input type="text" class="form-control" name="channel-id" value="{{ form.channel_id }}" style="min-width: 320px;">
                </div>

                <div>
                  <label class="mb-1">検索対象</label>
                  <select class="form-control" name="kind">
                    <option value="" {% if form.kind=='' %}selected{% endif %}>（両方）</option>
                    <option value="normal" {% if form.kind=='normal' %}selected{% endif %}>通常動画のみ</option>
                    <option value="shorts" {% if form.kind=='shorts' %}selected{% endif %}>ショートのみ</option>
                  </select>
                </div>

                <div>
                  <label class="mb-1">取得件数</label>
                  <input type="number" class="form-control" name="video-count" value="{{ form.video_count }}" min="1" max="2000" style="width:120px;">
                </div>

                <div>
                  <label class="mb-1">並び</label>
                  <select class="form-control" name="order">
                    <option value="date" {% if form.order=='date' %}selected{% endif %}>新しい順</option>
                    <option value="viewCount" {% if form.order=='viewCount' %}selected{% endif %}>再生数</option>
                    <option value="rating" {% if form.order=='rating' %}selected{% endif %}>高評価</option>
                  </select>
                </div>
              </div>

              <div class="divider"></div>

              <div class="form-row-gap d-flex flex-wrap align-items-end">
                <div>
                  <label class="mb-1">再生数 下限</label>
                  <input type="number" class="form-control" name="viewcount-level" value="{{ form.viewcount_min }}" style="width:140px;">
                </div>
                <div>
                  <label class="mb-1">再生数 上限</label>
                  <input type="number" class="form-control" name="viewcount-max" value="{{ form.viewcount_max }}" style="width:140px;">
                </div>
                <div>
                  <label class="mb-1">登録者 下限</label>
                  <input type="number" class="form-control" name="subscribercount-level" value="{{ form.sub_min }}" style="width:140px;">
                </div>
                <div>
                  <label class="mb-1">登録者 上限</label>
                  <input type="number" class="form-control" name="subscribercount-max" value="{{ form.sub_max }}" style="width:140px;">
                </div>

                <button type="submit" class="btn btn-primary">検索</button>
              </div>

              <div class="divider"></div>

              <div class="form-row-gap d-flex flex-wrap align-items-end">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="show_title" {% if form.show_title=='1' %}checked{% endif %}>
                  <label class="form-check-label" for="show_title">画像出力でタイトル表示</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="show_channel" {% if form.show_channel=='1' %}checked{% endif %}>
                  <label class="form-check-label" for="show_channel">画像出力でチャンネル名表示</label>
                </div>

                <div>
                  <label class="mb-1">画像間隔</label>
                  <input id="pad" type="number" class="form-control" value="{{ form.pad }}" style="width:110px;">
                </div>
                <div>
                  <label class="mb-1">サムネ幅（空=デフォ）</label>
                  <input id="thumb_w" type="number" class="form-control" value="{{ form.thumb_w }}" style="width:160px;" placeholder="例: 480">
                </div>
                <div class="hint">※ 出力ボタン側の「n / rows×cols」で件数をキリよく調整できます</div>
              </div>

              <input type="hidden" id="share_sid" value="{{ share_sid }}">
            </form>
          </div>
        </div>
      </details>
    </div>
  </div>

  <div class="container pb-5">
    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    {% if total_rows == 0 %}
      <div class="hint">検索条件を入れて「検索」を押してください。</div>
    {% else %}
      <div class="mb-2">
        <span class="badge badge-secondary">合計 {{ total_rows }} 件</span>
        <span class="badge badge-success">通常 {{ normal_rows|length }} 件</span>
        <span class="badge badge-info">ショート {{ short_rows|length }} 件</span>
      </div>

      <div class="share-box mb-3">
        <div class="share-actions">
          <div class="hint">X用まとめ画像：</div>

          <input type="hidden" id="count_normal" value="{{ normal_rows|length }}">
          <input type="hidden" id="count_shorts" value="{{ short_rows|length }}">

          <button id="shareNormal" type="button" class="btn btn-sm btn-outline-success" {% if normal_rows|length==0 %}disabled{% endif %}>通常だけ出力</button>
          <button id="shareShorts" type="button" class="btn btn-sm btn-outline-info" {% if short_rows|length==0 %}disabled{% endif %}>ショートだけ出力（黒ベタ除去）</button>

          <span class="hint">（別タブでPNGを開きます）</span>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div class="col-md-6">
            <div class="d-flex align-items-center justify-content-between">
              <div class="font-weight-bold">通常：グリッド設定</div>
              <div class="hint" id="grid_hint_normal"></div>
            </div>
            <div class="form-row-gap d-flex flex-wrap align-items-end mt-2">
              <div>
                <label class="mb-1">n（上位から）</label>
                <input id="share_n_normal" type="number" class="form-control" value="{{ form.share_n }}" placeholder="空=全件" style="width:140px;">
              </div>
              <div>
                <label class="mb-1">rows</label>
                <input id="grid_rows_normal" type="number" class="form-control" value="" style="width:110px;">
              </div>
              <div>
                <label class="mb-1">cols</label>
                <input id="grid_cols_normal" type="number" class="form-control" value="" style="width:110px;">
              </div>
            </div>
            <div id="grid_btns_normal" class="mt-2"></div>
          </div>

          <div class="col-md-6">
            <div class="d-flex align-items-center justify-content-between">
              <div class="font-weight-bold">ショート：グリッド設定</div>
              <div class="hint" id="grid_hint_shorts"></div>
            </div>
            <div class="form-row-gap d-flex flex-wrap align-items-end mt-2">
              <div>
                <label class="mb-1">n（上位から）</label>
                <input id="share_n_shorts" type="number" class="form-control" value="{{ form.share_n }}" placeholder="空=全件" style="width:140px;">
              </div>
              <div>
                <label class="mb-1">rows</label>
                <input id="grid_rows_shorts" type="number" class="form-control" value="" style="width:110px;">
              </div>
              <div>
                <label class="mb-1">cols</label>
                <input id="grid_cols_shorts" type="number" class="form-control" value="" style="width:110px;">
              </div>
            </div>
            <div id="grid_btns_shorts" class="mt-2"></div>
          </div>
        </div>
      </div>

      {% macro results_table(rows, table_id, kind_label, badge_class) %}
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <span class="badge {{ badge_class }}">{{ kind_label }}</span>
              <span class="hint ml-2">{{ rows|length }}件</span>
            </div>
          </div>
          <div class="card-body p-2">
            <table id="{{ table_id }}" class="table table-bordered table-sm tablesorter mb-0">
              <thead class="thead-light">
                <tr>
                  <th class="nowrap">投稿日時</th>
                  <th>タイトル</th>
                  <th>概要</th>
                  <th class="nowrap">再生数</th>
                  <th class="nowrap">高評価</th>
                  <th class="nowrap">コメント</th>
                  <th class="nowrap">時間</th>
                  <th class="nowrap">サムネ</th>
                  <th class="nowrap">URL</th>
                  <th class="nowrap">チャンネル</th>
                  <th class="nowrap">登録者</th>
                  <th class="nowrap">チャンネルURL</th>
                </tr>
              </thead>
              <tbody>
                {% for row in rows %}
                  {% set view = (row.get('viewCount') or 0) %}
                  {% set like = (row.get('likeCount') or 0) %}
                  {% set comm = (row.get('commentCount') or 0) %}
                  {% set sub = (row.get('subscriberCount') or 0) %}
                  <tr>
                    <td class="nowrap" data-sort-value="{{ row.get('publishedAt','') }}">{{ row.get('publishedAt','') }}</td>
                    <td><div class="text-content">{{ row.get('title','') }}</div></td>
                    <td><div class="text-content">{{ row.get('description','') }}</div></td>

                    <td class="nowrap" data-sort-value="{{ view|int }}">{{ "{:,}".format(view|int) }}</td>
                    <td class="nowrap" data-sort-value="{{ like|int }}">{{ "{:,}".format(like|int) }}</td>
                    <td class="nowrap" data-sort-value="{{ comm|int }}">
                      <a href="/comment?video-id={{ row.get('video_url','') }}" target="_blank">{{ "{:,}".format(comm|int) }}</a>
                    </td>

                    <td class="nowrap">{{ row.get('videoDuration','') }}</td>

                    <td class="nowrap">
                      {% if row.get('thumbnails') %}
                        <a href="{{ row.get('video_url','') }}" target="_blank">
                          <img src="{{ row.get('thumbnails') }}" height="72">
                        </a>
                      {% endif %}
                    </td>

                    <td class="nowrap"><a href="{{ row.get('video_url','') }}" target="_blank">open</a></td>
                    <td class="nowrap"><div class="text-content">{{ row.get('name','') }}</div></td>
                    <td class="nowrap" data-sort-value="{{ sub|int }}">{{ "{:,}".format(sub|int) }}</td>

                    <td class="nowrap">
                      {% if row.get('channel_icon') and row.get('channel_icon')|length >= 1 %}
                        <a href="{{ row.get('channel_icon')[0] }}" target="_blank">open</a>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endmacro %}

      {% if normal_rows|length > 0 %}
        {{ results_table(normal_rows, "fav-table-normal", "通常動画", "badge-success") }}
      {% endif %}
      {% if short_rows|length > 0 %}
        {{ results_table(short_rows, "fav-table-shorts", "ショート", "badge-info") }}
      {% endif %}
    {% endif %}
  </div>
</body>
</html>

<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>{{ title }}</title>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
        crossorigin="anonymous">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/js/jquery.tablesorter.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/css/theme.default.min.css">

  <script id="quota-json" type="application/json">{{ quota | tojson }}</script>

  <style>
    body { padding: 16px; }
    .header { display:flex; gap:12px; align-items:center; }
    .thumb { width: 160px; }
    .thumb img { width: 160px; border-radius: 10px; }
    .meta { flex:1; }
    .title { font-size: 18px; font-weight: 700; line-height: 1.25; }
    .muted { color:#666; }
    .quota-box { background:#f7f7f7; border-radius:10px; padding:10px 12px; font-size:12px; }
    #comment-table th { background-color: #b8f3ff; }
    .comment-text { white-space: pre-wrap; max-height: 140px; overflow-y: auto; }
    .nowrap { white-space: nowrap; }
    .icon img { border-radius: 50%; }
    .small { font-size: 12px; }
  </style>

  <script>
    function fmt(n){
      const x = Number(n);
      if (!Number.isFinite(x)) return String(n ?? "");
      return new Intl.NumberFormat("ja-JP").format(x);
    }

    $(function(){
      // quota表示（あれば）
      try{
        const quota = JSON.parse(document.getElementById("quota-json").textContent || "{}");
        $("#quota-used").text(fmt(quota.used ?? quota.used_estimate ?? 0));
        $("#quota-remaining").text(fmt(quota.remaining ?? quota.remaining_estimate ?? ""));
        $("#quota-reset").text(String(quota.reset_at_jst ?? quota.reset ?? ""));
      }catch(e){}

      $("#comment-table").tablesorter({
        theme: "default",
        textExtraction: function(node){
          const v = $(node).attr("data-sort-value");
          return (v !== undefined && v !== null) ? v : $(node).text();
        },
        headers: {
          0: { sorter: "digit" }, // No
          3: { sorter: "digit" }, // Like
          4: { sorter: "digit" }  // Reply
        }
      });
    });
  </script>
</head>

<body>

  <div class="d-flex justify-content-between align-items-start mb-3">
    <div class="header">
      <div class="thumb">
        {% if video_thumb %}
          <a href="{{ watch_url }}" target="_blank" rel="noopener noreferrer">
            <img src="{{ video_thumb }}" alt="thumb">
          </a>
        {% endif %}
      </div>
      <div class="meta">
        <div class="title">
          <a href="{{ watch_url }}" target="_blank" rel="noopener noreferrer">
            {{ video_title if video_title else "YouTube コメント" }}
          </a>
        </div>
        {% if channel_title %}
          <div class="muted">{{ channel_title }}</div>
        {% endif %}
        <div class="small muted">
          {% if mode == "replies" %}
            返信一覧モード
            <a href="/comment?video-id={{ video_id }}" class="ml-2">← トップコメント一覧へ</a>
          {% else %}
            トップコメント一覧モード
          {% endif %}
        </div>
      </div>
    </div>

    <div class="quota-box">
      <div><strong>Quota</strong> used: <span id="quota-used"></span> / remaining: <span id="quota-remaining"></span></div>
      <div class="muted">reset: <span id="quota-reset"></span></div>
    </div>
  </div>

  {% if error %}
    <div class="alert alert-warning">
      {{ error }}
    </div>
  {% endif %}

  <table id="comment-table" class="table table-bordered table-sm">
    <thead>
      <tr>
        <th class="nowrap">No</th>
        <th class="nowrap">投稿日</th>
        <th>コメント</th>
        <th class="nowrap">Like</th>
        <th class="nowrap">リプ</th>
        <th class="nowrap">ユーザーID</th>
        <th class="nowrap">icon</th>
        <th class="nowrap">URL</th>
      </tr>
    </thead>

    <tbody>
      {% for row in rows %}
        <tr>
          <td class="nowrap" data-sort-value="{{ row.get('no','0')|int }}">{{ row.get('no','') }}</td>

          <td class="nowrap" data-sort-value="{{ row.get('publishedAtIso','') }}">
            {{ row.get('publishedAt','') }}
          </td>

          <td>
            <div class="comment-text">{{- row.get('text','') | e -}}</div>
          </td>

          <td class="nowrap" data-sort-value="{{ row.get('likeCount',0)|int }}">
            {{ "{:,}".format(row.get('likeCount',0)|int) }}
          </td>

          <td class="nowrap" data-sort-value="{{ row.get('replyCount',0)|int }}">
            {% if mode != "replies" and row.get('replyCount',0)|int > 0 and row.get('repliesUrl','') %}
              <a href="{{ row.get('repliesUrl','') }}">
                {{ "{:,}".format(row.get('replyCount',0)|int) }}
              </a>
            {% else %}
              {{ "{:,}".format(row.get('replyCount',0)|int) }}
            {% endif %}
          </td>

          <td class="nowrap">
            {% if row.get('authorChannelUrl','') %}
              <a href="{{ row.get('authorChannelUrl','') }}" target="_blank" rel="noopener noreferrer">
                {{ row.get('userId','') }}
              </a>
            {% else %}
              {{ row.get('userId','') }}
            {% endif %}
          </td>

          <td class="icon nowrap">
            {% if row.get('iconUrl','') %}
              <img src="{{ row.get('iconUrl','') }}" height="34" alt="icon">
            {% endif %}
          </td>

          <td class="nowrap">
            <a href="{{ row.get('commentUrl','') }}" target="_blank" rel="noopener noreferrer">open</a>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if next_page_token %}
    <div class="mt-2">
      {% if mode == "replies" %}
        <a class="btn btn-outline-primary btn-sm"
           href="/comment?video-id={{ video_id }}&mode=replies&parent-id={{ parent_id }}&pageToken={{ next_page_token }}">
          次へ →
        </a>
      {% else %}
        <a class="btn btn-outline-primary btn-sm"
           href="/comment?video-id={{ video_id }}&pageToken={{ next_page_token }}">
          次へ →
        </a>
      {% endif %}
    </div>
  {% endif %}

</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>comment table</title>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/js/jquery.tablesorter.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/css/theme.default.min.css">

  <style>
    #comment-table th { background-color: pink; }
    .table td { max-width: 1100px; vertical-align: top; }

    /* 本文の改行は残す */
    .comment-cell { white-space: pre-wrap; }

    /* 返信の “>>” は付けるが、インデントはしない */
    .reply-badge { color: #007bff; font-weight: bold; margin-right: 6px; }

    .icn img { border-radius: 6px; }

    .col-comment { width: 60%; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>

  <script>
    $(document).ready(function() {
      $("#comment-table").tablesorter({
        headers: {
          2: { sorter: false }, // コメント本文は基本ソート不要ならOFF
          6: { sorter: false }  // icn
        }
      });
    });
  </script>
</head>

<body>
  <div class="container-fluid my-3">
    <div class="d-flex align-items-center">
      <a class="btn btn-sm btn-outline-secondary mr-2" href="/">検索へ</a>
      {% if watch_url %}
        <a class="btn btn-sm btn-outline-primary" href="{{ watch_url }}" target="_blank">動画を開く</a>
      {% endif %}
    </div>
    
    {% if video_meta %}
      <div class="d-flex align-items-center mt-3">
        {% if video_meta.thumbnail %}
          <a href="{{ watch_url }}" target="_blank" class="mr-3">
            <img src="{{ video_meta.thumbnail }}" height="90" style="border-radius:8px;">
          </a>
        {% endif %}
        <div>
          <div style="font-weight:700; font-size:18px;">{{ video_meta.title }}</div>
          {% if video_meta.channelTitle %}
            <div class="text-muted">{{ video_meta.channelTitle }}</div>
          {% endif %}
        </div>
      </div>
    {% endif %}

    {% if error %}
      <div class="alert alert-danger mt-3">{{ error }}</div>
    {% endif %}

    <table id="comment-table" class="table table-bordered mt-3">
      <thead>
        <tr>
          <th>No</th>
          <th>投稿日時</th>
          <th class="col-comment">コメント</th>
          <th>Like数</th>
          <th>リプライ数</th>
          <th>ユーザーID</th>
          <th>icn</th>
        </tr>
      </thead>

      <tbody>
      {% for r in rows %}
        <tr>
          <td data-sort-value="{{ r.sortNo }}">{{ r.no }}</td>
          <td class="mono" data-sort-value="{{ r.publishedAtIso }}">{{ r.publishedAt }}</td>

          <td>
            <div class="comment-cell">{%- if r.isReply -%}<span class="reply-badge">&gt;&gt;</span>{%- endif -%}{{- r.text -}}</div>
          </td>

          <td>{{ r.likeCount }}</td>
          <td>{{ r.replyCount }}</td>

          <td>
            {% if r.authorChannelUrl %}
              <a href="{{ r.authorChannelUrl }}" target="_blank">{{ r.userId }}</a>
            {% else %}
              {{ r.userId }}
            {% endif %}
          </td>

          <td class="icn">
            {% if r.iconUrl %}
              <img src="{{ r.iconUrl }}" height="40" width="40">
            {% endif %}
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>

    {% if next_page_token %}
      <a class="btn btn-outline-primary"
         href="/comment?video-id={{ video_id }}&pageToken={{ next_page_token }}">
        次のページ（トップコメント）
      </a>
    {% endif %}
  </div>
</body>
</html>

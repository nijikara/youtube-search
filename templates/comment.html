<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ title }}</title>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
        crossorigin="anonymous">
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/js/jquery.tablesorter.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.0/css/theme.default.min.css">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: "Noto Sans JP", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Yu Gothic", "Meiryo", sans-serif; }
    #cmt-table th { background-color: #ffe0f0; }
    .nowrap { white-space: nowrap; }
    .comment-cell { white-space: pre-wrap; }
    .icon { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
    .video-thumb { width: 240px; max-width: 100%; border-radius: 8px; }
    .small-muted { color: #666; font-size: 12px; }
  </style>

  <script>
    $(function(){
      $('#cmt-table').tablesorter({
        sortList: [[1,1]]
      });
    });
  </script>
</head>

<body>
<div class="container-fluid py-3">

  <div class="d-flex align-items-start flex-wrap">
    {% if video_thumb %}
      <a href="{{ watch_url }}" target="_blank" class="mr-3 mb-2">
        <img class="video-thumb" src="{{ video_thumb }}" alt="thumbnail">
      </a>
    {% endif %}
    <div class="mb-2">
      <div class="h5 mb-1"><a href="{{ watch_url }}" target="_blank">{{ video_title or 'Comments' }}</a></div>
      {% if channel_title %}<div class="small-muted">{{ channel_title }}</div>{% endif %}
      <div class="small-muted">mode: {{ mode }}{% if mode=='replies' and parent_id %} / parent: {{ parent_id }}{% endif %}</div>
      <div class="small-muted">quota(推定): used {{ quota.estimate_used }} / reset {{ quota.reset_at_jst }}</div>
    </div>
  </div>

  {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
  {% endif %}

  <div class="mb-2">
    {% if mode == 'replies' %}
      <a class="btn btn-sm btn-outline-secondary" href="/comment?video-id={{ watch_url }}" target="_self">← スレッドへ戻る</a>
    {% endif %}

    {% if next_page_token %}
      <a class="btn btn-sm btn-outline-primary" href="/comment?video-id={{ watch_url }}&mode={{ mode }}{% if parent_id %}&parent-id={{ parent_id }}{% endif %}&pageToken={{ next_page_token }}" target="_self">次のページ</a>
    {% endif %}
  </div>

  <table id="cmt-table" class="table table-bordered table-sm">
    <thead>
      <tr>
        <th class="nowrap">No</th>
        <th class="nowrap">投稿日</th>
        <th>コメント</th>
        <th class="nowrap">Like</th>
        <th class="nowrap">返信</th>
        <th class="nowrap">ユーザーID</th>
        <th class="nowrap">icn</th>
      </tr>
    </thead>
    <tbody>
    {% for r in rows %}
      <tr>
        <td class="nowrap" data-sort-value="{{ r.get('sortNo') or loop.index }}">
          {% if r.get('commentUrl') %}
            <a href="{{ r.get('commentUrl') }}" target="_blank">{{ r.get('no') }}</a>
          {% else %}
            {{ r.get('no') }}
          {% endif %}
        </td>
        <td class="nowrap" data-sort-value="{{ r.get('publishedAtIso') or r.get('publishedAt') }}">{{ r.get('publishedAt') }}</td>
        <td class="comment-cell">{{ r.get('text') }}</td>
        <td class="nowrap text-right" data-sort-value="{{ r.get('likeCount') or 0 }}">{{ "{:,}".format((r.get('likeCount') or 0)|int) }}</td>
        <td class="nowrap text-right" data-sort-value="{{ r.get('replyCount') or 0 }}">
          {% if mode == 'threads' and (r.get('replyCount') or 0) > 0 and r.get('commentId') %}
            <a href="/comment?video-id={{ watch_url }}&mode=replies&parent-id={{ r.get('commentId') }}" target="_self">{{ "{:,}".format((r.get('replyCount') or 0)|int) }}</a>
          {% else %}
            {{ "{:,}".format((r.get('replyCount') or 0)|int) }}
          {% endif %}
        </td>
        <td class="nowrap">
          {% if r.get('authorChannelUrl') %}
            <a href="{{ r.get('authorChannelUrl') }}" target="_blank">{{ r.get('userId') }}</a>
          {% else %}
            {{ r.get('userId') }}
          {% endif %}
        </td>
        <td class="nowrap">
          {% if r.get('iconUrl') %}
            <img class="icon" src="{{ r.get('iconUrl') }}" alt="icon">
          {% endif %}
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>

</div>
</body>
</html>
